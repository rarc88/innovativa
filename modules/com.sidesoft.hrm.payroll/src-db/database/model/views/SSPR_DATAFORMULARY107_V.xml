<?xml version="1.0"?>
  <database name="VIEW SSPR_DATAFORMULARY107_V">
    <view name="SSPR_DATAFORMULARY107_V"><![CDATA[SELECT i.name AS empleado, q.typeconcept AS value, to_char('') AS periodo, q.name AS concepto, c.taxid AS taxid_org, b.name AS org, n.year, n.c_year_id, i.c_bpartner_id, i.taxid AS taxid_employee, to_char(CASE WHEN i.em_sspr_documenttype = 'NI' THEN 'C' WHEN i.em_sspr_documenttype = 'P' THEN 'P' WHEN i.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END) AS tipoidentificacion, i.em_sspr_documentno AS numeroidentificacion, i.em_sspr_lastname AS empleadoapellido, i.em_sspr_firstname AS empleadonombre, s.value AS codigoestab, to_char(CASE WHEN m.countrycode = 'EC' THEN '01' ELSE '02' END) AS pais, m.em_sspr_coderesidence AS codigopais, to_char(CASE WHEN m.em_sspr_applyagreement = 'Y' THEN 'SI' ELSE 'NO' END) AS aplicaconvenio, to_char(CASE WHEN i.em_sspr_isdisabled = 'Y' THEN 'SI' ELSE 'NO' END) AS discapacitado, i.em_sspr_disability AS porcentajediscapacidad, to_char(COALESCE(CASE WHEN i.em_sspr_representsdisabled = 'Y' THEN CASE WHEN r.em_sspr_documenttype = 'NI' THEN 'C' WHEN r.em_sspr_documenttype = 'P' THEN 'P' WHEN r.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END ELSE NULL END, 'N')) AS tipoidentdiscapacidad, to_char(COALESCE(CASE WHEN i.em_sspr_representsdisabled = 'Y' THEN r.taxid ELSE NULL END, '999')) AS numeroidentifdiscapacidad, CASE WHEN q.typeconcept = 'TIOE' THEN sum(p.amount) ELSE 0.00 END AS ingresosgravados, CASE WHEN q.typeconcept = 'PCIOE' THEN sum(p.amount) ELSE 0.00 END AS aportepersonalo, CASE WHEN q.typeconcept = 'ED' THEN sum(p.amount) ELSE 0.00 END AS exoneracionpordiscapacidad, CASE WHEN q.typeconcept = 'ES' THEN sum(p.amount) ELSE 0.00 END AS exoneracionportercerasedad, 0.00 AS baseimponiblegrav, CASE WHEN q.typeconcept = 'VWAOE' THEN sum(p.amount) ELSE 0.00 END AS valorimpret403, CASE WHEN q.typeconcept = 'VTATE' THEN sum(p.amount) ELSE 0.00 END AS valorimpasumido405, z.taxid AS ruccontador FROM sspr_formulary107 o LEFT JOIN sspr_formularyline107 p ON o.sspr_formulary107_id = p.sspr_formulary107_id LEFT JOIN sspr_codeformulary107 q ON p.sspr_codeformulary107_id = q.sspr_codeformulary107_id LEFT JOIN c_year n ON o.c_year_id = n.c_year_id LEFT JOIN c_bpartner i ON p.c_bpartner_id = i.c_bpartner_id LEFT JOIN c_bpartner_location k ON i.c_bpartner_id = k.c_bpartner_id AND k.isactive = 'Y' LEFT JOIN c_location l ON k.c_location_id = l.c_location_id LEFT JOIN c_country m ON l.c_country_id = m.c_country_id LEFT JOIN ad_org b ON o.ad_org_id = b.ad_org_id LEFT JOIN ad_orginfo c ON b.ad_org_id = c.ad_org_id LEFT JOIN c_bpartner r ON i.em_sspr_bpartner_disabled_id = r.c_bpartner_id LEFT JOIN sspr_establishmentcode s ON i.em_sspr_establishmentcode_id = s.sspr_establishmentcode_id LEFT JOIN ad_clientinfo y ON b.ad_client_id = y.ad_client_id LEFT JOIN c_bpartner z ON y.em_sspr_c_bpartner_id = z.c_bpartner_id WHERE p.amount <> 0 AND (((SELECT count(*) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = i.c_bpartner_id)) = 0 OR k.created = ((SELECT max(y_1.created) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = i.c_bpartner_id))) GROUP BY c.taxid, i.em_sspr_disability, q.typeconcept, i.name, i.em_sspr_documenttype, i.em_sspr_documentno, b.description, m.countrycode, i.em_sspr_isdisabled, n.year, n.c_year_id, i.c_bpartner_id, b.name, q.name, m.em_sspr_coderesidence, m.em_sspr_applyagreement, i.taxid, i.em_sspr_lastname, i.em_sspr_firstname, s.value, i.em_sspr_representsdisabled, r.em_sspr_documenttype, r.taxid, z.taxid ORDER BY i.name, c.taxid]]></view>
  </database>
