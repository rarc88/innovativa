<?xml version="1.0"?>
  <database name="VIEW SSWH_PURCHASE_DETAIL_ATS3">
    <view name="SSWH_PURCHASE_DETAIL_ATS3"><![CDATA[SELECT h.c_invoice_id AS idob_factura, h.poreference AS numero_factura, h.dateinvoiced AS fecha_emision, cli.name AS empresa, live.value AS tipocomprobante, CASE WHEN live.name IS NULL OR live.name = '' THEN dt.name ELSE live.name END AS comprobante, h.dateacct AS fecha_registro, 0 AS basenograiva, CASE WHEN tax.rate = 0 THEN CASE WHEN tax.em_sswh_iswithholdingsource = 'N' THEN sum(imp.taxbaseamt) ELSE NULL END ELSE 0 END AS base_imponible, CASE WHEN tax.rate <> 0 THEN CASE WHEN tax.em_sswh_iswithholdingsource = 'N' THEN sum(imp.taxbaseamt) ELSE NULL END ELSE 0 END AS base_imponible_grava_iva, 0 AS monto_ice, CASE WHEN tax.rate <> 0 THEN CASE WHEN tax.em_sswh_iswithholdingsource = 'N' AND tax.istaxdeductable = 'Y' THEN sum(imp.taxamt) ELSE 0 END ELSE 0 END AS monto_iva, CASE WHEN l.excludeforwithholding = 'N' THEN CASE CASE WHEN prod.producttype = 'I' THEN (SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_goods_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id)))) ELSE (SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_services_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id)))) END WHEN (-30) THEN abs(CASE WHEN prod.producttype = 'I' THEN l.linenetamt * tax.rate / 100 * ((SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_goods_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id))))) / 100 ELSE l.linenetamt * tax.rate / 100 * ((SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_services_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id))))) / 100 END) ELSE 0 END ELSE 0.00 END AS valor_retencion_bienes, CASE WHEN l.excludeforwithholding = 'N' THEN CASE CASE WHEN prod.producttype = 'I' THEN (SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_goods_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id)))) ELSE (SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_services_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id)))) END WHEN (-70) THEN abs(CASE WHEN prod.producttype = 'I' THEN l.linenetamt * tax.rate / 100 * ((SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_goods_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id))))) / 100 ELSE l.linenetamt * tax.rate / 100 * ((SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_services_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id))))) / 100 END) ELSE 0 END ELSE 0.00 END AS valor_retencion_servicios, CASE WHEN l.excludeforwithholding = 'N' THEN CASE CASE WHEN prod.producttype = 'I' THEN (SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_goods_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id)))) ELSE (SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_services_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id)))) END WHEN (-100) THEN abs(CASE WHEN prod.producttype = 'I' THEN l.linenetamt * tax.rate / 100 * ((SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_goods_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id))))) / 100 ELSE l.linenetamt * tax.rate / 100 * ((SELECT c_tax.rate FROM c_tax WHERE c_tax.c_tax_id = (((SELECT sswh_withholding.c_tax_services_id FROM sswh_withholding WHERE sswh_withholding.sswh_taxpayer_id = 'A76BD743F94E4EF6A01AD22B566C5288' AND sswh_withholding.sswh_taxpayer_ref_id = taxp.sswh_taxpayer_id))))) / 100 END) ELSE 0 END ELSE 0.00 END AS valor_retencion_servicios_cien, h.documentno AS numero_documento, CASE WHEN tax.c_taxcategory_id = '64FB1552CE024A218AD09D14F16B6043' THEN sum(itax.taxamt) ELSE 0 END AS retencion_fuente, CASE WHEN tax.c_taxcategory_id = '0008D51878834F9A9FC795CDC36477C0' THEN sum(itax.taxamt) ELSE 0 END AS retencion_iva, CASE WHEN tax.c_tax_id = '1E34FAAAC55D4A6BAE32F919C9C6AC21' THEN sum(imp.taxbaseamt) ELSE 0 END AS base_iva_gasto, h.description AS descripcion FROM c_invoicelinetax imp LEFT JOIN c_invoiceline l ON imp.c_invoiceline_id = l.c_invoiceline_id LEFT JOIN c_invoice h ON l.c_invoice_id = h.c_invoice_id LEFT JOIN c_bpartner cli ON h.c_bpartner_id = cli.c_bpartner_id LEFT JOIN m_product prod ON l.m_product_id = prod.m_product_id LEFT JOIN c_doctype dt ON h.c_doctype_id = dt.c_doctype_id LEFT JOIN c_invoicetax itax ON h.c_invoice_id = itax.c_invoice_id LEFT JOIN c_tax tax ON itax.c_tax_id = tax.c_tax_id LEFT JOIN sswh_withholding_source whs ON prod.em_sswh_withholding_source_id = whs.sswh_withholding_source_id LEFT JOIN sswh_source sr ON whs.sswh_withholding_source_id = sr.sswh_withholding_source_id LEFT JOIN sswh_taxpayer taxp ON cli.em_sswh_taxpayer_id = taxp.sswh_taxpayer_id LEFT JOIN sswh_livelihoodt live ON live.sswh_livelihoodt_id = h.em_sswh_livelihood LEFT JOIN sswh_codelivelihoodt clive ON clive.sswh_codelivelihoodt_id = h.em_sswh_codelivelihood WHERE h.docstatus = 'CO' AND dt.docbasetype = 'API' AND dt.name <> 'Obligaciones Contables/NO Anexo' GROUP BY h.dateinvoiced, h.dateacct, h.poreference, cli.name, cli.taxid, clive.name, tax.rate, tax.istaxdeductable, tax.name, tax.taxindicator, imp.taxbaseamt, tax.em_sswh_iswithholdingsource, h.c_invoice_id, l.linenetamt, prod.producttype, taxp.sswh_taxpayer_id, live.value, live.name, clive.value, whs.name, h.em_sswh_nroauthorization, h.em_sswh_withholdingref, h.em_sswh_datewithhold, l.excludeforwithholding, taxp.name, dt.name, h.em_sswh_authorization, h.documentno, tax.c_taxcategory_id, tax.c_tax_id, h.description ORDER BY h.poreference]]></view>
  </database>
