<?xml version="1.0"?>
  <database name="VIEW SSWH_PURCHASE_FORMPAYMENT_NATS">
    <view name="SSWH_PURCHASE_FORMPAYMENT_NATS"><![CDATA[SELECT a.documentno, to_char(COALESCE(p.em_sswh_codeats, '00')) AS forma_pago, a.dateinvoiced, a.dateacct, a.posted, a.ad_org_id FROM c_invoice a LEFT JOIN fin_paymentmethod p ON a.fin_paymentmethod_id = p.fin_paymentmethod_id LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN (SELECT impuesto.c_invoice_id, sum(impuesto.importe_bruto) AS importe_bruto, sum(impuesto.importe_imponible) AS importe_imponible, sum(impuesto.impuesto) AS impuesto, sum(impuesto.basecero) AS basecero, sum(impuesto.base12) AS base12, sum(impuesto.iva) AS iva12 FROM (SELECT ci.c_invoice_id, sum(CASE WHEN ct.rate = 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxbaseamt WHEN ct.rate <> 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxbaseamt ELSE NULL END) + sum(CASE WHEN ct.rate <> 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxamt ELSE 0 END) AS importe_bruto, sum(CASE WHEN ct.rate = 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxbaseamt ELSE 0 END + CASE WHEN ct.rate <> 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxbaseamt ELSE 0 END + CASE WHEN ct.rate = 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxamt ELSE 0 END) AS importe_imponible, sum(CASE WHEN ct.rate <> 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxamt ELSE 0 END) AS impuesto, sum(CASE WHEN ct.rate = 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxbaseamt ELSE 0 END) AS basecero, sum(CASE WHEN ct.rate <> 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxbaseamt ELSE 0 END) AS base12, sum(CASE WHEN ct.rate <> 0 AND ct.istaxdeductable = 'Y' THEN cilt.taxamt ELSE 0 END) AS iva FROM c_invoice ci LEFT JOIN c_invoicetax cilt ON cilt.c_invoice_id = ci.c_invoice_id LEFT JOIN c_tax ct ON ct.c_tax_id = cilt.c_tax_id WHERE ct.istaxdeductable = 'Y' GROUP BY ci.c_invoice_id) impuesto GROUP BY impuesto.c_invoice_id) imp ON imp.c_invoice_id = a.c_invoice_id WHERE a.issotrx = 'N' AND a.processed = 'Y' AND a.docstatus <> 'VO' AND g.isreversal = 'N' AND g.docbasetype = 'API' AND g.em_sswh_implementautoriza = 'Y' AND (imp.importe_imponible + imp.impuesto) > 1000 GROUP BY a.documentno, p.em_sswh_codeats, a.dateinvoiced, a.dateacct, a.posted, a.ad_org_id]]></view>
  </database>
