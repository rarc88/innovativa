<?xml version="1.0"?>
  <database name="VIEW SSWH_SALESBYSTABLISHMENT_NATS">
    <view name="SSWH_SALESBYSTABLISHMENT_NATS"><![CDATA[SELECT rep_by_st.establecimiento, sum(rep_by_st.valor) AS valor, to_date(to_char(rep_by_st.dateinvoiced, 'dd/MM/yyyy')) AS dateinvoiced, to_date(to_char(rep_by_st.dateacct, 'dd/MM/yyyy')) AS dateacct, rep_by_st.posted, to_char(rep_by_st.ad_org_id) AS ad_org_id, COALESCE(sum(rep_by_st.compe), 0) AS compe, rep_by_st.documentno FROM (SELECT x.establecimiento, sum(x.total) AS valor, x.dateinvoiced, x.dateacct, x.posted, x.ad_org_id, sum(x.compen) AS compe, x.documentno FROM (SELECT substr(h.prefix, 1, 3) AS establecimiento, sum(a.totallines) AS total, a.dateinvoiced, a.dateacct, a.posted, a.ad_org_id, comp.compensated_amount AS compen, CASE sswh_document_ei(g.c_doctype_id) WHEN 'Y' THEN 'E' ELSE 'F' END AS tipo_em, a.documentno FROM c_invoice a LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN ad_sequence h ON g.docnosequence_id = h.ad_sequence_id LEFT JOIN (SELECT sia.c_invoice_id, sia.afectedzone_code AS comp_type, sia.monto_iva * COALESCE(sia.afectedzone_percent, 100) / 100 AS compensated_amount FROM sswh_salesinvoice_nats sia WHERE sia.afectedzone = 'Y' AND sia.afectedzone_code = '01') comp ON comp.c_invoice_id = a.c_invoice_id WHERE a.issotrx = 'Y' AND a.processed = 'Y' AND a.docstatus <> 'VO' AND g.em_sswh_implementautoriza = 'Y' AND g.isreversal = 'N' AND g.docbasetype = 'ARI' GROUP BY a.c_doctype_id, g.name, h.prefix, a.dateinvoiced, a.dateacct, a.posted, a.ad_org_id, comp.compensated_amount, g.c_doctype_id, a.documentno UNION ALL SELECT nc.substr, nc.total * CASE WHEN nc.total > 0 THEN (-1) ELSE 1 END, nc.dateinvoiced, nc.dateacct, nc.posted, nc.ad_org_id, nc.compen, nc.tipo_em, nc.documentno FROM (SELECT substr(h.prefix, 1, 3) AS substr, sum(a.totallines) AS total, a.dateinvoiced, a.dateacct, a.posted, a.ad_org_id, 0 AS compen, CASE sswh_document_ei(g.c_doctype_id) WHEN 'Y' THEN 'E' ELSE 'F' END AS tipo_em, a.documentno FROM c_invoice a LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN ad_sequence h ON g.docnosequence_id = h.ad_sequence_id WHERE a.issotrx = 'Y' AND a.processed = 'Y' AND a.docstatus <> 'VO' AND g.em_sswh_implementautoriza = 'Y' AND (g.isreversal = 'Y' OR (g.docbasetype IN ('ARC', 'ARI_RM'))) GROUP BY a.c_doctype_id, g.name, h.prefix, a.dateinvoiced, a.dateacct, a.posted, a.ad_org_id, g.c_doctype_id, a.documentno) nc) x WHERE x.tipo_em = 'F' GROUP BY x.establecimiento, x.dateinvoiced, x.dateacct, x.posted, x.ad_org_id, x.documentno ORDER BY x.ad_org_id) rep_by_st GROUP BY rep_by_st.establecimiento, rep_by_st.dateinvoiced, rep_by_st.dateacct, rep_by_st.ad_org_id, rep_by_st.posted, rep_by_st.documentno ORDER BY rep_by_st.documentno]]></view>
  </database>
