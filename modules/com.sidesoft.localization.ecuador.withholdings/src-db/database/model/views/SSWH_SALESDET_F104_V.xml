<?xml version="1.0"?>
  <database name="VIEW SSWH_SALESDET_F104_V">
    <view name="SSWH_SALESDET_F104_V"><![CDATA[SELECT a.c_invoice_id, CASE c.em_sswh_taxidtype WHEN 'R' THEN '04' WHEN 'P' THEN '06' WHEN 'D' THEN '05' WHEN 'C' THEN '07' ELSE NULL END AS tipo_identificador, CASE c.em_sswh_taxidtype WHEN 'C' THEN to_char('9999999999999') ELSE c.taxid END AS identif_cliente, CASE c.em_sswh_taxidtype WHEN 'C' THEN to_char('CF') ELSE to_char(c.name) END AS nombre_cliente, '18' AS cod_tipo_comprobante, g.name AS doctype, CASE g.docbasetype WHEN 'ARI' THEN 'FACTURA' WHEN 'ARC' THEN 'NOTA CREDITO' ELSE NULL END AS basedoctype, a.documentno, count(DISTINCT a.c_invoice_id) AS count, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.istaxundeductable WHEN 'Y' THEN CASE f.rate WHEN 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS base_no_iva, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.istaxdeductable WHEN 'Y' THEN CASE f.rate WHEN 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS base_iva_cero, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.istaxdeductable WHEN 'Y' THEN CASE WHEN f.rate <> 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS base_iva_doce, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.istaxdeductable WHEN 'Y' THEN CASE WHEN f.rate <> 0 THEN e.taxamt ELSE 0.00 END ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS monto_iva, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.em_sswh_ats_iva WHEN 'Y' THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS monto_ret_iva, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.em_sswh_ats_source WHEN 'Y' THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS monto_ret_renta, CASE a.em_ssre_isrefund WHEN 'Y' THEN CASE WHEN ref.m_product_id IS NULL THEN 0.00 ELSE sum(CASE f.istaxdeductable WHEN 'Y' THEN CASE f.rate WHEN 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.istaxdeductable WHEN 'Y' THEN CASE WHEN f.rate <> 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END) END ELSE 0.00 END * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS valor_reembolso, a.dateacct, a.posted FROM c_invoice a LEFT JOIN c_invoiceline al ON a.c_invoice_id = al.c_invoice_id LEFT JOIN c_bpartner c ON a.c_bpartner_id = c.c_bpartner_id LEFT JOIN c_invoicelinetax e ON al.c_invoiceline_id = e.c_invoiceline_id LEFT JOIN c_tax f ON e.c_tax_id = f.c_tax_id LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN ssre_refund_configuration ref ON ref.m_product_id = al.m_product_id WHERE a.issotrx = 'Y' AND a.processed = 'Y' AND a.docstatus <> 'VO' AND g.em_sswh_implementautoriza = 'Y' AND g.isreversal = 'N' AND g.docbasetype = 'ARI' GROUP BY g.docbasetype, c.em_sswh_taxidtype, c.taxid, c.name, g.name, a.documentno, ref.m_product_id, a.c_invoice_id, a.em_ssre_isrefund, g.isreversal, a.dateacct, a.posted UNION ALL SELECT a.c_invoice_id, CASE c.em_sswh_taxidtype WHEN 'R' THEN '04' WHEN 'P' THEN '06' WHEN 'D' THEN '05' WHEN 'C' THEN '07' ELSE NULL END AS tipo_identificador, CASE c.em_sswh_taxidtype WHEN 'C' THEN to_char('9999999999999') ELSE c.taxid END AS identif_cliente, CASE c.em_sswh_taxidtype WHEN 'C' THEN to_char('CF') ELSE to_char(c.name) END AS nombre_cliente, '04' AS cod_tipo_comprobante, g.name AS doctype, CASE g.docbasetype WHEN 'ARI' THEN 'FACTURA' WHEN 'ARC' THEN 'NOTA CREDITO' ELSE NULL END AS basedoctype, a.documentno, count(DISTINCT a.c_invoice_id) AS count, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.istaxundeductable WHEN 'Y' THEN CASE f.rate WHEN 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS base_no_iva, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.istaxdeductable WHEN 'Y' THEN CASE f.rate WHEN 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS base_iva_cero, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.istaxdeductable WHEN 'Y' THEN CASE WHEN f.rate <> 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS base_iva_doce, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.istaxdeductable WHEN 'Y' THEN CASE WHEN f.rate <> 0 THEN e.taxamt ELSE 0.00 END ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS monto_iva, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.em_sswh_ats_iva WHEN 'Y' THEN e.taxamt ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS monto_ret_iva, sum(CASE a.em_ssre_isrefund WHEN 'N' THEN CASE f.em_sswh_ats_source WHEN 'Y' THEN e.taxamt ELSE 0.00 END ELSE 0.00 END) * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS monto_ret_renta, CASE a.em_ssre_isrefund WHEN 'Y' THEN CASE WHEN ref.m_product_id IS NULL THEN 0.00 ELSE sum(CASE f.istaxdeductable WHEN 'Y' THEN CASE f.rate WHEN 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.istaxdeductable WHEN 'Y' THEN CASE WHEN f.rate <> 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END) END ELSE 0.00 END * CASE WHEN g.isreversal = 'Y' THEN (-1) ELSE 1 END AS valor_reembolso, a.dateacct, a.posted FROM c_invoice a LEFT JOIN c_invoiceline al ON a.c_invoice_id = al.c_invoice_id LEFT JOIN c_bpartner c ON a.c_bpartner_id = c.c_bpartner_id LEFT JOIN c_invoicelinetax e ON al.c_invoiceline_id = e.c_invoiceline_id LEFT JOIN c_tax f ON e.c_tax_id = f.c_tax_id LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN ssre_refund_configuration ref ON ref.m_product_id = al.m_product_id WHERE a.issotrx = 'Y' AND a.processed = 'Y' AND a.docstatus <> 'VO' AND g.em_sswh_implementautoriza = 'Y' AND (g.isreversal = 'Y' OR (g.docbasetype IN ('ARC', 'ARI_RM'))) GROUP BY g.docbasetype, c.em_sswh_taxidtype, c.taxid, c.name, g.name, a.documentno, ref.m_product_id, a.c_invoice_id, a.em_ssre_isrefund, g.isreversal, a.dateacct, a.posted ORDER BY 6]]></view>
  </database>
