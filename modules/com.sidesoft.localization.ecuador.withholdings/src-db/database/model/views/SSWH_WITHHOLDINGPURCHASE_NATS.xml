<?xml version="1.0"?>
  <database name="VIEW SSWH_WITHHOLDINGPURCHASE_NATS">
    <view name="SSWH_WITHHOLDINGPURCHASE_NATS"><![CDATA[SELECT x.documentno, x.document, x.name, x.codigo_ret, x.base_imp, x.porcen_ret, sum(x.valor_ret) AS valor_ret, x.dateinvoiced, x.c_bpartner_id, x.ref_retencion, x.posted, x.dateacct, x.poreference, x.exceptcod, x.ad_org_id FROM (SELECT a.documentno, g.name AS document, f.name, f.taxindicator AS codigo_ret, sum(e.taxbaseamt) AS base_imp, f.rate * (-1) AS porcen_ret, sum(e.taxamt * (-1)) AS valor_ret, a.dateinvoiced, a.c_bpartner_id, COALESCE(to_char(a.em_sswh_withholdingref), to_char('')) AS ref_retencion, a.posted, a.dateacct, a.poreference, COALESCE(d.value, '0') AS exceptcod, a.ad_org_id FROM c_invoice a LEFT JOIN c_invoicetax e ON a.c_invoice_id = e.c_invoice_id LEFT JOIN c_tax f ON e.c_tax_id = f.c_tax_id LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN sswh_livelihoodt d ON a.em_sswh_livelihood = d.sswh_livelihoodt_id WHERE a.issotrx = 'N' AND a.processed = 'Y' AND a.docstatus <> 'VO' AND g.em_sswh_implementautoriza = 'Y' AND g.isreversal = 'N' AND f.em_sswh_ats_source = 'Y' AND g.docbasetype = 'API' AND to_number(f.rate) <> 0 AND d.value <> '41' GROUP BY a.documentno, a.poreference, f.taxindicator, f.rate, g.name, f.name, a.dateinvoiced, a.c_bpartner_id, a.em_sswh_withholdingref, a.posted, a.dateacct, d.value, a.ad_org_id UNION ALL SELECT a.documentno, g.name AS document, f.name, '332' AS codigo_ret, sum(e.taxbaseamt) AS base_imp, 0.00 AS porcen_ret, 0.00 AS valor_ret, a.dateinvoiced, a.c_bpartner_id, COALESCE(to_char(a.em_sswh_withholdingref), to_char('')) AS ref_retencion, a.posted, a.dateacct, a.poreference, COALESCE(d.value, '0') AS exceptcod, a.ad_org_id FROM c_invoice a LEFT JOIN c_invoicetax e ON a.c_invoice_id = e.c_invoice_id LEFT JOIN c_tax f ON e.c_tax_id = f.c_tax_id LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN sswh_livelihoodt d ON a.em_sswh_livelihood = d.sswh_livelihoodt_id WHERE a.issotrx = 'N' AND a.processed = 'Y' AND a.docstatus <> 'VO' AND g.em_sswh_implementautoriza = 'Y' AND g.isreversal = 'N' AND f.em_sswh_ats_source = 'Y' AND g.docbasetype = 'API' AND f.description = '332' GROUP BY a.documentno, a.poreference, f.taxindicator, f.rate, g.name, f.name, a.dateinvoiced, a.c_bpartner_id, a.em_sswh_withholdingref, a.posted, a.dateacct, d.value, a.ad_org_id UNION ALL SELECT a.documentno, g.name AS document, taxn.name, '332' AS codigo_ret, sum(e.taxbaseamt) AS base_imp, 0.00 AS porcen_ret, 0.00 AS valor_ret, a.dateinvoiced, a.c_bpartner_id, COALESCE(to_char(a.em_sswh_withholdingref), to_char('')) AS ref_retencion, a.posted, a.dateacct, a.poreference, COALESCE(d.value, '0') AS exceptcod, a.ad_org_id FROM c_invoice a JOIN c_invoiceline cil ON cil.c_invoice_id = a.c_invoice_id LEFT JOIN c_invoicelinetax e ON cil.c_invoiceline_id = e.c_invoiceline_id LEFT JOIN c_tax f ON e.c_tax_id = f.c_tax_id LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN sswh_livelihoodt d ON a.em_sswh_livelihood = d.sswh_livelihoodt_id JOIN (SELECT c_tax.name, c_tax.description FROM c_tax WHERE c_tax.description = '332') taxn ON taxn.description = '332' WHERE a.issotrx = 'N' AND a.processed = 'Y' AND g.docbasetype = 'API' AND cil.excludeforwithholding = 'Y' AND g.em_sswh_implementautoriza = 'Y' GROUP BY a.documentno, g.name, taxn.name, a.dateinvoiced, a.c_bpartner_id, COALESCE(to_char(a.em_sswh_withholdingref), to_char('')), a.posted, a.dateacct, a.poreference, d.value, a.ad_org_id UNION ALL SELECT e.documentno, f.name AS document, d.name, d.taxindicator AS codigo_ret, sum(CASE WHEN b.linenetamt = 0 THEN b.lineivaamt ELSE b.linenetamt END) AS base_imp, d.rate * (-1) AS porcen_ret, sum(CASE WHEN b.whrentalamt = 0 THEN b.whivaamt ELSE b.whrentalamt END) AS valor_ret, CASE WHEN to_char(a.withholdingdate, 'MM') = to_char((SELECT c_invoice.dateinvoiced FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id), 'MM') THEN (SELECT c_invoice.dateinvoiced FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id) ELSE a.withholdingdate END AS withholdingdate, a.c_bpartner_id, COALESCE(to_char(e.em_sswh_withholdingref), to_char(a.documentno)) AS ref_retencion, a.posted, CASE WHEN to_char(a.dateacct, 'MM') = to_char((SELECT c_invoice.dateacct FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id), 'MM') THEN (SELECT c_invoice.dateacct FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id) ELSE a.dateacct END AS dateacct, e.poreference, COALESCE(g.value, '0') AS exceptcod, a.ad_org_id FROM ssws_withholdingsale a LEFT JOIN ssws_withholdingsaleline b ON a.ssws_withholdingsale_id = b.ssws_withholdingsale_id LEFT JOIN c_doctype c ON a.c_doctype_id = c.c_doctype_id LEFT JOIN c_tax d ON b.c_tax_id = d.c_tax_id LEFT JOIN c_invoice e ON a.c_invoice_id = e.c_invoice_id LEFT JOIN c_doctype f ON e.c_doctype_id = f.c_doctype_id LEFT JOIN sswh_livelihoodt g ON e.em_sswh_livelihood = g.sswh_livelihoodt_id WHERE a.withholdingtype = 'WP' AND a.processed = 'Y' AND a.docstatus <> 'VO' AND c.em_sswh_implementautoriza = 'Y' AND d.em_sswh_ats_source = 'Y' AND to_number(d.rate) <> 0 GROUP BY a.documentno, e.documentno, e.poreference, d.taxindicator, d.rate, f.name, d.name, a.c_bpartner_id, a.posted, a.withholdingdate, a.dateacct, e.em_sswh_withholdingref, a.c_invoice_id, g.value, a.ad_org_id UNION ALL SELECT a.documentno, g.name AS document, N'' || sswh_get_descriptiontax(to_char(g.em_sswh_withh_code)) AS desc_tax_name, to_char(g.em_sswh_withh_code) AS codigo_ret, sum(e.taxbaseamt) AS base_imp, 0.00 AS porcen_ret, 0.00 AS valor_ret, a.dateinvoiced, a.c_bpartner_id, COALESCE(to_char(a.em_sswh_withholdingref), to_char('')) AS ref_retencion, a.posted, a.dateacct, a.poreference, COALESCE(d.value, '0') AS exceptcod, a.ad_org_id FROM c_invoice a JOIN c_invoiceline cil ON cil.c_invoice_id = a.c_invoice_id LEFT JOIN c_invoicelinetax e ON cil.c_invoiceline_id = e.c_invoiceline_id LEFT JOIN c_tax f ON e.c_tax_id = f.c_tax_id LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN sswh_livelihoodt d ON a.em_sswh_livelihood = d.sswh_livelihoodt_id   join c_tax ctx on ctx.em_eei_sri_taxcat_code = g.em_sswh_withh_code WHERE a.issotrx = 'N' AND a.processed = 'Y' AND g.docbasetype = 'API' AND g.em_sswh_implementautoriza = 'Y' AND g.em_sswh_ext_withh = 'Y' AND g.em_sswh_withh_code IS NOT NULL GROUP BY a.documentno, g.name, a.dateinvoiced, a.c_bpartner_id, COALESCE(to_char(a.em_sswh_withholdingref), to_char('')), a.posted, a.dateacct, a.poreference, d.value, a.ad_org_id, g.em_sswh_withh_code ORDER BY 1) x WHERE x.exceptcod <> '41' GROUP BY x.documentno, x.document, x.codigo_ret, x.porcen_ret, x.base_imp, x.name, x.c_bpartner_id, x.posted, x.dateacct, x.dateinvoiced, x.poreference, x.ref_retencion, x.exceptcod, x.ad_org_id ORDER BY x.documentno]]></view>
  </database>
