<?xml version="1.0"?>
  <database name="VIEW SSPR_FORMULARY107_V">
    <view name="SSPR_FORMULARY107_V"><![CDATA[SELECT i.name AS empleado, h.typeconcept AS value, j.name AS periodo, g.name AS concepto, c.taxid AS taxid_org, b.name AS org, 'nomina' AS "desc", n.year, n.c_year_id, i.c_bpartner_id, i.taxid AS taxid_employee, to_char(CASE WHEN i.em_sspr_documenttype = 'NI' THEN 'C' WHEN i.em_sspr_documenttype = 'P' THEN 'P' WHEN i.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END) AS tipoidentificacion, i.em_sspr_documentno AS numeroidentificacion, i.em_sspr_lastname AS empleadoapellido, i.em_sspr_firstname AS empleadonombre, o.value AS codigoestab, to_char(CASE WHEN m.countrycode = 'EC' THEN '01' ELSE '02' END) AS pais, m.em_sspr_coderesidence AS codigopais, to_char(CASE WHEN m.em_sspr_applyagreement = 'Y' THEN 'SI' ELSE 'NO' END) AS aplicaconvenio, to_char(CASE WHEN i.em_sspr_isdisabled = 'Y' THEN 'SI' ELSE 'NO' END) AS discapacitado, i.em_sspr_disability AS porcentajediscapacidad, to_char(COALESCE(CASE WHEN i.em_sspr_representsdisabled = 'Y' THEN CASE WHEN p.em_sspr_documenttype = 'NI' THEN 'C' WHEN p.em_sspr_documenttype = 'P' THEN 'P' WHEN p.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END ELSE NULL END, 'N')) AS tipoidentdiscapacidad, to_char(COALESCE(CASE WHEN i.em_sspr_representsdisabled = 'Y' THEN p.taxid ELSE NULL END, '999')) AS numeroidentifdiscapacidad, CASE WHEN h.typeconcept = 'RM' THEN sum(f.amount) ELSE 0.00 END AS sueldo, CASE WHEN h.typeconcept = 'BC' THEN sum(f.amount) ELSE 0.00 END AS bonos, CASE WHEN h.typeconcept = 'UT' THEN sum(f.amount) ELSE 0.00 END AS utilidades, CASE WHEN h.typeconcept = 'ITAE' THEN sum(f.amount) ELSE 0.00 END AS impuestorenta, CASE WHEN h.typeconcept = 'TS' AND h.em_ssph_earned = 'Y' THEN sum(f.amount) ELSE 0.00 END AS decimotercero, CASE WHEN h.typeconcept = 'FS' AND h.em_ssph_earned = 'Y' THEN sum(f.amount) ELSE 0.00 END AS decimocuarto, 0.00 AS fondosreserva, 0.00 AS compensacionsalariodigno, CASE WHEN h.typeconcept = 'OINT' THEN sum(f.amount) ELSE 0.00 END AS otrosing_rentagravada, 1 AS sistemasalariodigno, CASE WHEN h.typeconcept = 'PCITE' THEN sum(f.amount) ELSE 0.00 END AS aportepersonal, CASE WHEN h.typeconcept = 'ITC' THEN sum(f.amount) ELSE 0.00 END AS impuestorentacausado, CASE WHEN h.typeconcept = 'VTWWTE' THEN sum(f.amount) ELSE 0.00 END AS valorimprettrabajador, z.taxid AS ruccontador, CASE WHEN to_number(i.em_sspr_disability) > 0 AND i.em_sspr_isdisabled = 'Y' THEN to_number(round(to_number(COALESCE((SELECT min(sspr_incometaxline.basemax) * 2 FROM sspr_incometax LEFT JOIN sspr_incometaxline ON sspr_incometaxline.sspr_incometax_id = sspr_incometax.sspr_incometax_id WHERE sspr_incometax.c_year_id = n.c_year_id), 0)) * to_number(COALESCE((SELECT sspr_disabilityline.percentage FROM sspr_disabilityline LEFT JOIN sspr_disability ON sspr_disability.sspr_disability_id = sspr_disabilityline.sspr_disability_id WHERE sspr_disabilityline.grade_disability_from <= to_number(i.em_sspr_disability) AND sspr_disabilityline.grade_disability_to >= to_number(i.em_sspr_disability) AND sspr_disability.c_year_id = n.c_year_id), 0)) / to_number(100), 2)) ELSE to_number(0) END AS exoneracionpordiscapacidad, CASE WHEN to_number(abs(COALESCE(to_number(to_char(i.em_sspr_birthday, 'yyyy')), 0) - COALESCE(to_number(to_char(to_date(now()), 'yyyy')), 0))) >= 65 THEN round(COALESCE((SELECT min(sspr_incometaxline.basemax) * 2 FROM sspr_incometax LEFT JOIN sspr_incometaxline ON sspr_incometaxline.sspr_incometax_id = sspr_incometax.sspr_incometax_id WHERE sspr_incometax.c_year_id = n.c_year_id), 0) * COALESCE((SELECT sspr_disability.value_seniors FROM sspr_disability WHERE sspr_disability.c_year_id = n.c_year_id), 0) / 100, 2) ELSE 0 END AS exoneracionportercerasedad FROM sspr_payroll a LEFT JOIN ad_org b ON a.ad_org_id = b.ad_org_id LEFT JOIN ad_orginfo c ON b.ad_org_id = c.ad_org_id LEFT JOIN c_bpartner e ON c.c_bpartner_id = e.c_bpartner_id LEFT JOIN sspr_payroll_ticket d ON a.sspr_payroll_id = d.sspr_payroll_id LEFT JOIN sspr_payroll_ticket_concept f ON d.sspr_payroll_ticket_id = f.sspr_payroll_ticket_id LEFT JOIN sspr_concept g ON f.sspr_concept_id = g.sspr_concept_id LEFT JOIN sspr_codeformulary107 h ON g.sspr_codeformulary107_id = h.sspr_codeformulary107_id LEFT JOIN c_bpartner i ON d.c_bpartner_id = i.c_bpartner_id LEFT JOIN c_period j ON a.c_period_id = j.c_period_id LEFT JOIN c_bpartner_location k ON i.c_bpartner_id = k.c_bpartner_id AND k.isactive = 'Y' LEFT JOIN c_location l ON k.c_location_id = l.c_location_id LEFT JOIN c_country m ON l.c_country_id = m.c_country_id LEFT JOIN c_year n ON j.c_year_id = n.c_year_id LEFT JOIN c_bpartner p ON i.em_sspr_bpartner_disabled_id = p.c_bpartner_id LEFT JOIN sspr_establishmentcode o ON i.em_sspr_establishmentcode_id = o.sspr_establishmentcode_id LEFT JOIN ad_clientinfo y ON b.ad_client_id = y.ad_client_id LEFT JOIN c_bpartner z ON y.em_sspr_c_bpartner_id = z.c_bpartner_id WHERE a.isliquidation = 'N' AND a.processed = 'Y' AND a.ispayroll = 'Y' AND f.amount <> 0 AND (((SELECT count(*) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = i.c_bpartner_id)) = 0 OR k.created = ((SELECT max(y_1.created) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = i.c_bpartner_id))) GROUP BY c.taxid, i.em_sspr_disability, h.typeconcept, i.name, j.name, g.name, i.em_sspr_documenttype, i.em_sspr_documentno, b.description, m.countrycode, i.em_sspr_isdisabled, n.year, n.c_year_id, i.c_bpartner_id, b.name, m.em_sspr_coderesidence, m.em_sspr_applyagreement, i.taxid, i.em_sspr_lastname, i.em_sspr_firstname, i.em_sspr_representsdisabled, p.em_sspr_documenttype, o.value, p.taxid, z.taxid, h.em_ssph_earned, i.em_sspr_birthday UNION ALL SELECT i.name AS empleado, h.typeconcept AS value, j.name AS periodo, g.name AS concepto, c.taxid AS taxid_org, b.name AS org, 'decimos' AS "desc", n.year, n.c_year_id, i.c_bpartner_id, i.taxid AS taxid_employee, to_char(CASE WHEN i.em_sspr_documenttype = 'NI' THEN 'C' WHEN i.em_sspr_documenttype = 'P' THEN 'P' WHEN i.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END) AS tipoidentificacion, i.em_sspr_documentno AS numeroidentificacion, i.em_sspr_lastname AS empleadoapellido, i.em_sspr_firstname AS empleadonombre, o.value AS codigoestab, to_char(CASE WHEN m.countrycode = 'EC' THEN '01' ELSE '02' END) AS pais, m.em_sspr_coderesidence AS codigopais, to_char(CASE WHEN m.em_sspr_applyagreement = 'Y' THEN 'SI' ELSE 'NO' END) AS aplicaconvenio, to_char(CASE WHEN i.em_sspr_isdisabled = 'Y' THEN 'SI' ELSE 'NO' END) AS discapacitado, i.em_sspr_disability AS porcentajediscapacidad, to_char(COALESCE(CASE WHEN i.em_sspr_representsdisabled = 'Y' THEN CASE WHEN p.em_sspr_documenttype = 'NI' THEN 'C' WHEN p.em_sspr_documenttype = 'P' THEN 'P' WHEN p.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END ELSE NULL END, 'N')) AS tipoidentdiscapacidad, to_char(COALESCE(CASE WHEN i.em_sspr_representsdisabled = 'Y' THEN p.taxid ELSE NULL END, '999')) AS numeroidentifdiscapacidad, 0.00 AS sueldo, 0.00 AS bonos, 0.00 AS utilidades, 0.00 AS impuestorenta, 0.00 AS decimotercero, 0.00 AS decimocuarto, CASE WHEN h.typeconcept = 'RF' THEN sum(f.amount) ELSE 0.00 END AS fondosreserva, 0.00 AS compensacionsalariodigno, 0.00 AS otrosing_rentagravada, 1 AS sistemasalariodigno, 0.00 AS aportepersonal, 0.00 AS impuestorentacausado, 0.00 AS valorimprettrabajador, z.taxid AS ruccontador, to_number(0) AS exoneracionpordiscapacidad, to_number(0) AS exoneracionportercerasedad FROM sspr_payroll a LEFT JOIN ad_org b ON a.ad_org_id = b.ad_org_id LEFT JOIN ad_orginfo c ON b.ad_org_id = c.ad_org_id LEFT JOIN c_bpartner e ON c.c_bpartner_id = e.c_bpartner_id LEFT JOIN sspr_payroll_ticket d ON a.sspr_payroll_id = d.sspr_payroll_id LEFT JOIN sspr_payroll_ticket_concept f ON d.sspr_payroll_ticket_id = f.sspr_payroll_ticket_id LEFT JOIN sspr_concept g ON f.sspr_concept_id = g.sspr_concept_id LEFT JOIN sspr_codeformulary107 h ON g.sspr_codeformulary107_id = h.sspr_codeformulary107_id LEFT JOIN c_bpartner i ON d.c_bpartner_id = i.c_bpartner_id LEFT JOIN c_period j ON a.c_period_id = j.c_period_id LEFT JOIN c_bpartner_location k ON i.c_bpartner_id = k.c_bpartner_id AND k.isactive = 'Y' LEFT JOIN c_location l ON k.c_location_id = l.c_location_id LEFT JOIN c_country m ON l.c_country_id = m.c_country_id LEFT JOIN c_year n ON j.c_year_id = n.c_year_id LEFT JOIN c_bpartner p ON i.em_sspr_bpartner_disabled_id = p.c_bpartner_id LEFT JOIN sspr_establishmentcode o ON i.em_sspr_establishmentcode_id = o.sspr_establishmentcode_id LEFT JOIN ad_clientinfo y ON b.ad_client_id = y.ad_client_id LEFT JOIN c_bpartner z ON y.em_sspr_c_bpartner_id = z.c_bpartner_id WHERE a.isliquidation = 'N' AND a.processed = 'Y' AND (((SELECT count(*) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = i.c_bpartner_id)) = 0 OR f.amount <> 0 AND k.created = ((SELECT max(y_1.created) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = i.c_bpartner_id))) GROUP BY c.taxid, i.em_sspr_disability, h.typeconcept, i.name, j.name, g.name, i.em_sspr_documenttype, i.em_sspr_documentno, b.description, m.countrycode, i.em_sspr_isdisabled, n.year, n.c_year_id, i.c_bpartner_id, b.name, m.em_sspr_coderesidence, m.em_sspr_applyagreement, i.taxid, f.em_ssph_earned, h.em_ssph_earned, i.em_sspr_lastname, i.em_sspr_firstname, i.em_sspr_representsdisabled, p.em_sspr_documenttype, o.value, p.taxid, z.taxid ORDER BY 1, 3, 4, 5]]></view>
  </database>
