<?xml version="1.0"?>
  <database name="FUNCTION SSPR_ACUMULATIVECONCEPTSX">
    <function name="SSPR_ACUMULATIVECONCEPTSX" type="NULL">
      <body><![CDATA[/*  FUNCION QUE GENERA EL ACUMULADO DE LOS VALORES DE LOS CONCEPTOS DE NOMINA
* Explicación:
*
* 1- Recoge los valores de cada concepto que interviene en calculo de la renta 
*    (valores finales utilizados en la generacion de la nomina).
* 2- Realiza los calculos de acumulacion de los valores de cada concepto
* 3- Inserta los valores en un tabla acumulada sspr_cumulativeconcept
* 4. Tabla que intervienen: sspr_payroll_ticket_concept ||sspr_payroll_ticket||sspr_payroll||
     sspr_concept || c_period
* Desarrollado por: Santiago Simbaña - Sidesoft Cia. Ltda.
* Fecha Ultima Modificacion:12diciembre20121600
**********************************************************************************/
TYPE RECORD IS REF CURSOR;
Cur_Parameter RECORD;
Cur_ConceptA RECORD;
CUR_EMPLEADO RECORD;
Cur_process_payroll RECORD;
  v_Client_ID VARCHAR2(32);
  v_Org_ID VARCHAR2(32);
  v_User_ID VARCHAR2(32) ;
  
  v_ResultStr VARCHAR2(2000) := '';  


  v_Period_ID VARCHAR2(32); 
  v_n_insertions NUMBER;
  v_Message VARCHAR2(2000):='';

  V_YEAR_ACTUAL VARCHAR2(32) ;
  V_PERIOD_ACTUAL VARCHAR2(32) ;

  V_PERIOD_ANTERIOR VARCHAR2(32) ;
  VALOR_ANTERIOR NUMBER;
  VALOR_ACTUAL NUMBER;
  V_MESSAGE_ACUM VARCHAR2(2000):='';
  V_NOPERIODO NUMBER;
  NEW_PROJECTED NUMBER;
  V_SSPR_CONCEPTOUT_ID VARCHAR2(32) ; 
  
BEGIN

  --BEGIN --BODY
    -- Get Parameters
    v_ResultStr := 'ReadingParameters';
    v_n_insertions := 0;  

    DELETE FROM SSPR_CUMULATIVECONCEPT;
    
    /*FOR Cur_ConceptA IN 
			   (SELECT A.AD_CLIENT_ID, A.AD_ORG_ID,A.CREATEDBY, A.UPDATEDBY,A.SSPR_CONCEPT_ID, B.C_BPARTNER_ID, C.C_PERIOD_ID, SUM(A.AMOUNT ) AS AMOUNT
				,BB.PERIODNO,BB.C_YEAR_ID, D.ISCUMULATIVE,D.ISPROJECTED,D.CONCEPTSUBTYPE,D.ISIESS,

				COALESCE(TO_NUMBER((SELECT SUM(W.AMOUNT) FROM sspr_payroll_ticket_concept W
				LEFT JOIN sspr_payroll_ticket BA ON W.sspr_payroll_ticket_id = BA.sspr_payroll_ticket_id
				LEFT JOIN sspr_payroll CA on  BA.sspr_payroll_id= CA.sspr_payroll_id
				LEFT JOIN C_PERIOD X ON CA.C_PERIOD_ID=X.C_PERIOD_ID  AND X.ISACTIVE='Y' 
				LEFT JOIN SSPR_CONCEPT Z ON A.SSPR_CONCEPT_ID=Z.SSPR_CONCEPT_ID
				WHERE  (Z.ISINCOMETAX= 'Y' AND  Z.ISCUMULATIVE = 'Y' AND W.SSPR_CONCEPT_ID = A.SSPR_CONCEPT_ID AND BA.C_BPARTNER_ID = B.C_BPARTNER_ID AND CA.ISPAYROLL='Y' AND X.PERIODNO <= BB.PERIODNO) 
				OR ( Z.ISINCOMECALCULATED='Y' AND  Z.ISCUMULATIVE = 'Y' AND W.SSPR_CONCEPT_ID = A.SSPR_CONCEPT_ID AND BA.C_BPARTNER_ID = B.C_BPARTNER_ID AND CA.ISPAYROLL='Y' AND X.PERIODNO <= BB.PERIODNO ) )),0) AS CUMULATIVE

				,COALESCE(TO_NUMBER((((SELECT COALESCE(TO_NUMBER(SUM(W.AMOUNT)),0) FROM sspr_payroll_ticket_concept W
				LEFT JOIN sspr_payroll_ticket BA ON W.sspr_payroll_ticket_id = BA.sspr_payroll_ticket_id
				LEFT JOIN sspr_payroll CA on  BA.sspr_payroll_id= CA.sspr_payroll_id
				LEFT JOIN C_PERIOD X ON CA.C_PERIOD_ID=X.C_PERIOD_ID and x.ISACTIVE='Y'
				LEFT JOIN SSPR_CONCEPT Z ON A.SSPR_CONCEPT_ID=Z.SSPR_CONCEPT_ID
				WHERE Z.ISINCOMECALCULATED='Y' AND Z.ISCUMULATIVE = 'Y' AND Z.ISPROJECTED='Y' AND CA.ISPAYROLL='Y' 
				AND W.SSPR_CONCEPT_ID = A.SSPR_CONCEPT_ID AND BA.C_BPARTNER_ID = B.C_BPARTNER_ID AND X.PERIODNO <= BB.PERIODNO)/BB.PERIODNO) * (12 - BB.PERIODNO))),0) AS PROJECTED

				
				FROM sspr_payroll_ticket_concept A
				LEFT JOIN sspr_payroll_ticket B ON A.sspr_payroll_ticket_id = B.sspr_payroll_ticket_id
				LEFT JOIN sspr_payroll C on  B.sspr_payroll_id= C.sspr_payroll_id
				LEFT JOIN C_PERIOD BB ON C.C_PERIOD_ID=BB.C_PERIOD_ID --AND BB.ISACTIVE='Y'
				LEFT JOIN C_YEAR CYA ON BB.C_YEAR_ID=CYA.C_YEAR_ID  
				LEFT JOIN SSPR_CONCEPT D ON A.SSPR_CONCEPT_ID=D.SSPR_CONCEPT_ID
				LEFT JOIN C_BPARTNER CBP ON B.C_BPARTNER_ID = CBP.C_BPARTNER_ID 
				WHERE  cya.isactive='Y'AND CBP.ISACTIVE='Y'and  D.ISINCOMECALCULATED='Y' OR  D.ISINCOMETAX= 'Y' AND C.ISPAYROLL='Y' and cya.isactive='Y' AND CBP.ISACTIVE='Y'  and bb.isactive='Y'
				GROUP BY A.SSPR_CONCEPT_ID, B.C_BPARTNER_ID, C.C_PERIOD_ID ,BB.PERIODNO,BB.C_YEAR_ID,A.AD_CLIENT_ID, A.AD_ORG_ID,A.CREATEDBY, A.UPDATEDBY, D.ISCUMULATIVE, D.ISPROJECTED,
				D.CONCEPTSUBTYPE,D.ISIESS,C.ISPAYROLL
				ORDER BY 6,5 --1, 2, 3, 5, 6
				
			   ) */
		--OBTENGO EL CONCEPTO IMPUESTO A LA RENTA
		SELECT SSPR_PROCESS_PAYROLL.SSPR_CONCEPTOUT_ID
		INTO V_SSPR_CONCEPTOUT_ID 
		FROM SSPR_PROCESS_PAYROLL
		WHERE PROCESSNAME='IT' AND ISACTIVE = 'Y';
		
			 FOR Cur_ConceptA IN
			 (
			 SELECT A.AD_CLIENT_ID, A.AD_ORG_ID,A.CREATEDBY, A.UPDATEDBY,A.SSPR_CONCEPT_ID, B.C_BPARTNER_ID, C.C_PERIOD_ID, SUM(A.AMOUNT ) AS AMOUNT
				,BB.PERIODNO,BB.C_YEAR_ID, D.ISCUMULATIVE,D.ISPROJECTED,D.CONCEPTSUBTYPE,D.ISIESS,

				COALESCE(TO_NUMBER((SELECT SUM(W.AMOUNT) FROM sspr_payroll_ticket_concept W
				LEFT JOIN sspr_payroll_ticket BA ON W.sspr_payroll_ticket_id = BA.sspr_payroll_ticket_id
				LEFT JOIN sspr_payroll CA on  BA.sspr_payroll_id= CA.sspr_payroll_id
				LEFT JOIN C_PERIOD X ON CA.C_PERIOD_ID=X.C_PERIOD_ID  AND X.ISACTIVE='Y' 
				LEFT JOIN SSPR_CONCEPT Z ON W.SSPR_CONCEPT_ID=Z.SSPR_CONCEPT_ID
				WHERE  (
				Z.SSPR_CONCEPT_ID = V_SSPR_CONCEPTOUT_ID
				AND  Z.ISCUMULATIVE = 'Y' AND W.SSPR_CONCEPT_ID = A.SSPR_CONCEPT_ID AND BA.C_BPARTNER_ID = B.C_BPARTNER_ID AND CA.ISPAYROLL='Y' AND X.PERIODNO <= BB.PERIODNO) 
				OR ( Z.ISINCOMECALCULATED='Y' AND  Z.ISCUMULATIVE = 'Y' AND W.SSPR_CONCEPT_ID = A.SSPR_CONCEPT_ID AND BA.C_BPARTNER_ID = B.C_BPARTNER_ID AND CA.ISPAYROLL='Y' AND X.PERIODNO <= BB.PERIODNO ) AND  Z.SSPR_CONCEPT_ID = A.SSPR_CONCEPT_ID )),0) AS CUMULATIVE

				,COALESCE(TO_NUMBER((((SELECT COALESCE(TO_NUMBER(SUM(W.AMOUNT)),0) FROM sspr_payroll_ticket_concept W
				LEFT JOIN sspr_payroll_ticket BA ON W.sspr_payroll_ticket_id = BA.sspr_payroll_ticket_id
				LEFT JOIN sspr_payroll CA on  BA.sspr_payroll_id= CA.sspr_payroll_id
				LEFT JOIN C_PERIOD X ON CA.C_PERIOD_ID=X.C_PERIOD_ID and x.ISACTIVE='Y'
				LEFT JOIN SSPR_CONCEPT Z ON W.SSPR_CONCEPT_ID=Z.SSPR_CONCEPT_ID
				WHERE Z.ISINCOMECALCULATED='Y' AND Z.ISCUMULATIVE = 'Y' AND Z.ISPROJECTED='Y' AND CA.ISPAYROLL='Y' 
				AND W.SSPR_CONCEPT_ID = A.SSPR_CONCEPT_ID AND BA.C_BPARTNER_ID = B.C_BPARTNER_ID AND X.PERIODNO <= BB.PERIODNO AND A.SSPR_CONCEPT_ID=Z.SSPR_CONCEPT_ID)/BB.PERIODNO) * (12 - BB.PERIODNO))),0) AS PROJECTED

				
				FROM sspr_payroll_ticket_concept A
				LEFT JOIN sspr_payroll_ticket B ON A.sspr_payroll_ticket_id = B.sspr_payroll_ticket_id
				LEFT JOIN sspr_payroll C on  B.sspr_payroll_id= C.sspr_payroll_id
				LEFT JOIN C_PERIOD BB ON C.C_PERIOD_ID=BB.C_PERIOD_ID --AND BB.ISACTIVE='Y'
				LEFT JOIN C_YEAR CYA ON BB.C_YEAR_ID=CYA.C_YEAR_ID  
				LEFT JOIN SSPR_CONCEPT D ON A.SSPR_CONCEPT_ID=D.SSPR_CONCEPT_ID
				LEFT JOIN C_BPARTNER CBP ON B.C_BPARTNER_ID = CBP.C_BPARTNER_ID 
				WHERE  cya.isactive='Y'AND CBP.ISACTIVE='Y'and  D.ISINCOMECALCULATED='Y' OR  
				D.SSPR_CONCEPT_ID = V_SSPR_CONCEPTOUT_ID
				AND C.ISPAYROLL='Y' and cya.isactive='Y' AND CBP.ISACTIVE='Y'  and bb.isactive='Y'
				GROUP BY A.SSPR_CONCEPT_ID, B.C_BPARTNER_ID, C.C_PERIOD_ID ,BB.PERIODNO,BB.C_YEAR_ID,A.AD_CLIENT_ID, A.AD_ORG_ID,A.CREATEDBY, A.UPDATEDBY, D.ISCUMULATIVE, D.ISPROJECTED,
				D.CONCEPTSUBTYPE,D.ISIESS,C.ISPAYROLL
				ORDER BY 6,5 --1, 2, 3, 5, 6
         )
			   LOOP
				Insert into SSPR_CUMULATIVECONCEPT (SSPR_CUMULATIVECONCEPT_ID, AD_CLIENT_ID, AD_ORG_ID, ISACTIVE, CREATED, CREATEDBY, UPDATED, UPDATEDBY,
				SSPR_CONCEPT_ID,C_BPARTNER_ID,C_PERIOD_ID,AMOUNTCONCEPT,PERIODNO,C_YEAR_ID,NOTOTALPERIOD,ACUMULATIVE,AMOUNTPROJECTED,ISCUMULATIVE, ISPROJECTED,CONCEPTSUBTYPE,ISIESS)
				values(get_uuid(), Cur_ConceptA.AD_CLIENT_ID,Cur_ConceptA.AD_ORG_ID, 'Y', 
				now(), Cur_ConceptA.CREATEDBY,  now(), Cur_ConceptA.UPDATEDBY,
				Cur_ConceptA.sspr_concept_id, Cur_ConceptA.c_bpartner_id,Cur_ConceptA.C_Period_ID, Cur_ConceptA.amount,
				Cur_ConceptA.periodno, Cur_ConceptA.c_year_id,12,Cur_ConceptA.CUMULATIVE,Cur_ConceptA.PROJECTED,Cur_ConceptA.ISCUMULATIVE,Cur_ConceptA.ISPROJECTED,
				Cur_ConceptA.CONCEPTSUBTYPE,Cur_ConceptA.ISIESS);
				v_n_insertions:=v_n_insertions+1;
			 END LOOP;
			

			/*MODIFICACION PARA LA VARIACION DEL SUELDO CON RESPECTO AL PROYECTADO*/

			--OBTENER EL PERIODO MAXIMO O ACTUAL DE LA NOMINA 
			SELECT DISTINCT C_YEAR_ID, C_PERIOD_ID, PERIODNO
			INTO V_YEAR_ACTUAL , V_PERIOD_ACTUAL, V_NOPERIODO
			FROM SSPR_CUMULATIVECONCEPT 
			WHERE periodno = (SELECT max(periodno) FROM SSPR_CUMULATIVECONCEPT);--"84FB284977A84279B0FA27F12D8ACE4B"
			

			--OBTENER EL PERIODO MAXIMO - 1 ;  PERIODO ANTERIOR AL ACTUAL
			SELECT DISTINCT  C_PERIOD_ID
			INTO  V_PERIOD_ANTERIOR
			FROM SSPR_CUMULATIVECONCEPT 
			WHERE periodno = (SELECT max(periodno) - 1  FROM SSPR_CUMULATIVECONCEPT);--""F1C3C00BE2A44082BF4070333B0EC40D"" "23884ECBC4AE4EF2A634A70550620B7B"
			
				
			FOR CUR_EMPLEADO IN 
				( SELECT * FROM C_BPARTNER WHERE ISEMPLOYEE ='Y' AND ISACTIVE = 'Y')
				LOOP
					--RAISE notice '%', '@loop 2@';
					--VALOR DEL CONCEPTO A LA FECHA DEL ROL MAXIMO
					SELECT A.AMOUNT INTO VALOR_ACTUAL
					FROM sspr_payroll_ticket_concept A
					LEFT JOIN sspr_payroll_ticket B ON A.sspr_payroll_ticket_id = B.sspr_payroll_ticket_id
					LEFT JOIN sspr_payroll C on  B.sspr_payroll_id= C.sspr_payroll_id
					WHERE  sspr_concept_id = '538D100C35904C4480317533C8464706' --V_SSPR_CONCEPTOUT_ID--CONCEPTO SUELDO
					AND b.c_bpartner_id = CUR_EMPLEADO.C_BPARTNER_ID
					AND c.c_period_id = V_PERIOD_ACTUAL;
				
					--VALOR DEL CONCEPTO A LA FECHA DEL ROL MAXIMO - 1 (DEL ROL ANTERIOR)
					SELECT  A.AMOUNT INTO VALOR_ANTERIOR
					FROM sspr_payroll_ticket_concept A
					LEFT JOIN sspr_payroll_ticket B ON A.sspr_payroll_ticket_id = B.sspr_payroll_ticket_id
					LEFT JOIN sspr_payroll C on  B.sspr_payroll_id= C.sspr_payroll_id
					WHERE  sspr_concept_id = '538D100C35904C4480317533C8464706' --V_SSPR_CONCEPTOUT_ID --538D100C35904C4480317533C8464706'--CONCEPTO SUELDO
					AND b.c_bpartner_id = CUR_EMPLEADO.C_BPARTNER_ID
					AND c.c_period_id = V_PERIOD_ANTERIOR;

					IF VALOR_ACTUAL <> VALOR_ANTERIOR THEN
						--RAISE notice '%', '@sueldo a variado@'||CUR_EMPLEADO.C_BPARTNER_ID||' anterior'||VALOR_ANTERIOR ||' - actual'||VALOR_ACTUAL;
						--V_MESSAGE_ACUM := '@sueldo a variado@'|| COALESCE(TO_CHAR((SELECT NAME FROM C_BPARTNER WHERE C_BPARTNER_ID = CUR_EMPLEADO.C_BPARTNER_ID)),'') ||' anterior'||VALOR_ANTERIOR ||' - actual'||VALOR_ACTUAL;
						--INSERT INTO SSPR_LOG_RENTA VALUES (V_MESSAGE_ACUM);
						NEW_PROJECTED := (VALOR_ACTUAL * (12 - V_NOPERIODO)) ;
						UPDATE SSPR_CUMULATIVECONCEPT	SET  AMOUNTPROJECTED = NEW_PROJECTED
						WHERE SSPR_CONCEPT_ID = '538D100C35904C4480317533C8464706' -- V_SSPR_CONCEPTOUT_ID--'538D100C35904C4480317533C8464706' AND C_BPARTNER_ID = CUR_EMPLEADO.C_BPARTNER_ID
						AND C_PERIOD_ID = V_PERIOD_ACTUAL;
					END IF;
				END LOOP;

  --RETURN;
    
  --END; --BODY
  --EXCEPTION
  --WHEN OTHERS THEN
   -- v_ResultStr:= '@ERROR=' || SQLERRM;
    --RAISE notice '%',v_ResultStr ;
     DBMS_OUTPUT.PUT_LINE(v_ResultStr) ;
    --PERFORM AD_UPDATE_PINSTANCE(PInstance_ID, NULL, 'N', 0, v_ResultStr) ;
    RETURN;
END SSPR_ACUMULATIVECONCEPTSX
]]></body>
    </function>
  </database>
