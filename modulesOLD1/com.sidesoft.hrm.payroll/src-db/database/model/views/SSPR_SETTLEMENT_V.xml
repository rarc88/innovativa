<?xml version="1.0"?>
  <database name="VIEW SSPR_SETTLEMENT_V">
    <view name="SSPR_SETTLEMENT_V"><![CDATA[SELECT g.name AS empleado, l.typeconcept AS codigolines, to_char('') AS periodo, l.name AS concepto, e.taxid AS taxid_org, d.name AS org, j.year, j.c_year_id, g.c_bpartner_id, g.taxid AS taxid_employee, to_char(CASE WHEN g.em_sspr_documenttype = 'NI' THEN 'C' WHEN g.em_sspr_documenttype = 'P' THEN 'P' WHEN g.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END) AS tipoidentificacion, g.em_sspr_documentno AS numeroidentificacion, g.em_sspr_lastname AS empleadoapellido, g.em_sspr_firstname AS empleadonombre, r.value AS codigoestab, to_char(CASE WHEN m.countrycode = 'EC' THEN '01' ELSE '02' END) AS pais, m.em_sspr_coderesidence AS codigopais, to_char(CASE WHEN m.em_sspr_applyagreement = 'Y' THEN 'SI' ELSE 'NO' END) AS aplicaconvenio, to_char(CASE WHEN g.em_sspr_isdisabled = 'Y' THEN 'SI' ELSE 'NO' END) AS discapacitado, g.em_sspr_disability AS porcentajediscapacidad, to_char(COALESCE(CASE WHEN g.em_sspr_representsdisabled = 'Y' THEN CASE WHEN p.em_sspr_documenttype = 'NI' THEN 'C' WHEN p.em_sspr_documenttype = 'P' THEN 'P' WHEN p.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END ELSE NULL END, 'N')) AS tipoidentdiscapacidad, to_char(COALESCE(CASE WHEN g.em_sspr_representsdisabled = 'Y' THEN p.taxid ELSE NULL END, '999')) AS numeroidentifdiscapacidad, CASE WHEN l.typeconcept = 'RM' THEN sum(b.amount) ELSE 0.00 END AS sueldo, CASE WHEN l.typeconcept = 'BC' THEN sum(b.amount) ELSE 0.00 END AS bonos, CASE WHEN l.typeconcept = 'ITAE' THEN sum(b.amount) ELSE 0.00 END AS impuestorenta, CASE WHEN l.typeconcept = 'TS' THEN sum(b.amount) ELSE 0.00 END AS decimotercero, CASE WHEN l.typeconcept = 'FS' THEN sum(b.amount) ELSE 0.00 END AS decimocuarto, CASE WHEN l.typeconcept = 'RF' THEN sum(b.amount) ELSE 0.00 END AS fondosreserva, CASE WHEN l.typeconcept = 'OINT' THEN sum(b.totalnet) ELSE 0.00 END AS otrosing_rentagravada, CASE WHEN l.typeconcept = 'PCITE' THEN CASE WHEN k.conceptsubtype = 'In' THEN sum(b.amount) WHEN k.conceptsubtype = 'Out' THEN sum(b.amount) * (-1) ELSE NULL END ELSE 0.00 END AS aportepersonal, CASE WHEN l.typeconcept = 'VTWWTE' THEN sum(b.amount) ELSE 0.00 END AS valorimprettrabajador, z.taxid AS ruccontador FROM sspr_settlement a LEFT JOIN sspr_settlementline b ON a.sspr_settlement_id = b.sspr_settlement_id LEFT JOIN ad_org d ON a.ad_org_id = d.ad_org_id LEFT JOIN ad_orginfo e ON a.ad_org_id = e.ad_org_id LEFT JOIN c_bpartner f ON e.c_bpartner_id = f.c_bpartner_id LEFT JOIN c_bpartner g ON a.c_bpartner_id = g.c_bpartner_id LEFT JOIN c_year j ON to_char(a.movementdate, 'yyyy') = j.year LEFT JOIN sspr_concept k ON b.sspr_concept_id = k.sspr_concept_id LEFT JOIN sspr_codeformulary107 l ON k.sspr_codeformulary107_id = l.sspr_codeformulary107_id LEFT JOIN c_bpartner_location n ON g.c_bpartner_id = n.c_bpartner_id AND n.isactive = 'Y' AND n.isactive = 'Y' LEFT JOIN c_location o ON n.c_location_id = o.c_location_id LEFT JOIN c_country m ON o.c_country_id = m.c_country_id LEFT JOIN c_bpartner p ON g.em_sspr_bpartner_disabled_id = p.c_bpartner_id LEFT JOIN sspr_establishmentcode r ON g.em_sspr_establishmentcode_id = r.sspr_establishmentcode_id LEFT JOIN ad_clientinfo y ON d.ad_client_id = y.ad_client_id LEFT JOIN c_bpartner z ON y.em_sspr_c_bpartner_id = z.c_bpartner_id WHERE a.processed = 'Y' AND a.complete = 'Y' AND b.amount <> 0 AND (((SELECT count(*) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = g.c_bpartner_id)) = 0 OR n.created = ((SELECT max(y_1.created) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = g.c_bpartner_id))) GROUP BY g.name, l.typeconcept, d.name, j.year, j.c_year_id, g.c_bpartner_id, g.taxid, l.name, e.taxid, d.description, m.countrycode, m.em_sspr_coderesidence, m.em_sspr_applyagreement, g.em_sspr_documentno, g.em_sspr_isdisabled, g.em_sspr_disability, g.em_sspr_lastname, g.em_sspr_firstname, p.em_sspr_documenttype, p.taxid, r.value, g.em_sspr_representsdisabled, z.taxid, l.em_ssph_earned, g.em_sspr_documenttype, k.conceptsubtype UNION ALL SELECT g.name AS empleado, n.typeconcept AS codigolines, to_char('') AS periodo, n.name AS concepto, e.taxid AS taxid_org, d.name AS org, j.year, j.c_year_id, g.c_bpartner_id, g.taxid AS taxid_employee, to_char(CASE WHEN g.em_sspr_documenttype = 'NI' THEN 'C' WHEN g.em_sspr_documenttype = 'P' THEN 'P' WHEN g.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END) AS tipoidentificacion, g.em_sspr_documentno AS numeroidentificacion, g.em_sspr_lastname AS empleadoapellido, g.em_sspr_firstname AS empleadonombre, s.value AS codigoestab, to_char(CASE WHEN q.countrycode = 'EC' THEN '01' ELSE '02' END) AS pais, q.em_sspr_coderesidence AS codigopais, to_char(CASE WHEN q.em_sspr_applyagreement = 'Y' THEN 'SI' ELSE 'NO' END) AS aplicaconvenio, to_char(CASE WHEN g.em_sspr_isdisabled = 'Y' THEN 'SI' ELSE 'NO' END) AS discapacitado, g.em_sspr_disability AS porcentajediscapacidad, to_char(COALESCE(CASE WHEN g.em_sspr_representsdisabled = 'Y' THEN CASE WHEN r.em_sspr_documenttype = 'NI' THEN 'C' WHEN r.em_sspr_documenttype = 'P' THEN 'P' WHEN r.em_sspr_documenttype = 'SRT' THEN 'E' ELSE NULL END ELSE NULL END, 'N')) AS tipoidentdiscapacidad, to_char(COALESCE(CASE WHEN g.em_sspr_representsdisabled = 'Y' THEN r.taxid ELSE NULL END, '999')) AS numeroidentifdiscapacidad, CASE WHEN n.typeconcept = 'RM' THEN sum(c.amount) ELSE 0.00 END AS sueldo, CASE WHEN n.typeconcept = 'BC' THEN sum(c.amount) ELSE 0.00 END AS bonos, CASE WHEN n.typeconcept = 'ITAE' THEN sum(c.amount) ELSE 0.00 END AS impuestorenta, CASE WHEN n.typeconcept = 'TS' THEN sum(c.amount) ELSE 0.00 END AS decimotercero, CASE WHEN n.typeconcept = 'FS' THEN sum(c.amount) ELSE 0.00 END AS decimocuarto, CASE WHEN n.typeconcept = 'RF' THEN sum(c.amount) ELSE 0.00 END AS fondosreserva, CASE WHEN n.typeconcept = 'OINT' THEN sum(c.totalnet) ELSE 0.00 END AS otrosing_rentagravada, CASE WHEN n.typeconcept = 'PCITE' THEN CASE WHEN m.conceptsubtype = 'In' THEN sum(c.amount) WHEN m.conceptsubtype = 'Out' THEN sum(c.amount) * (-1) ELSE NULL END ELSE 0.00 END AS aportepersonal, CASE WHEN n.typeconcept = 'VTWWTE' THEN sum(c.amount) ELSE 0.00 END AS valorimprettrabajador, z.taxid AS ruccontador FROM sspr_settlement a LEFT JOIN sspr_settlementdata c ON a.sspr_settlement_id = c.sspr_settlement_id LEFT JOIN ad_org d ON a.ad_org_id = d.ad_org_id LEFT JOIN ad_orginfo e ON a.ad_org_id = e.ad_org_id LEFT JOIN c_bpartner f ON e.c_bpartner_id = f.c_bpartner_id LEFT JOIN c_bpartner g ON a.c_bpartner_id = g.c_bpartner_id LEFT JOIN c_year j ON to_char(a.movementdate, 'yyyy') = j.year LEFT JOIN sspr_concept m ON c.sspr_concept_id = m.sspr_concept_id LEFT JOIN sspr_codeformulary107 n ON m.sspr_codeformulary107_id = n.sspr_codeformulary107_id LEFT JOIN c_bpartner_location p ON g.c_bpartner_id = p.c_bpartner_id AND p.isactive = 'Y' LEFT JOIN c_location o ON p.c_location_id = o.c_location_id LEFT JOIN c_country q ON o.c_country_id = q.c_country_id LEFT JOIN c_bpartner r ON g.em_sspr_bpartner_disabled_id = r.c_bpartner_id LEFT JOIN sspr_establishmentcode s ON g.em_sspr_establishmentcode_id = s.sspr_establishmentcode_id LEFT JOIN ad_clientinfo y ON d.ad_client_id = y.ad_client_id LEFT JOIN c_bpartner z ON y.em_sspr_c_bpartner_id = z.c_bpartner_id WHERE a.processed = 'Y' AND a.complete = 'Y' AND c.amount <> 0 AND (((SELECT count(*) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = g.c_bpartner_id)) = 0 OR p.created = ((SELECT max(y_1.created) AS max FROM c_bpartner_location y_1 WHERE y_1.c_bpartner_id = g.c_bpartner_id))) GROUP BY g.name, n.typeconcept, d.name, j.year, j.c_year_id, g.c_bpartner_id, g.taxid, n.name, e.taxid, d.description, q.countrycode, q.em_sspr_coderesidence, q.em_sspr_applyagreement, g.em_sspr_documenttype, g.em_sspr_documentno, g.em_sspr_isdisabled, g.em_sspr_disability, g.em_sspr_lastname, g.em_sspr_firstname, r.em_sspr_documenttype, r.taxid, s.value, g.em_sspr_representsdisabled, z.taxid, n.em_ssph_earned, m.conceptsubtype ORDER BY 1]]></view>
  </database>
