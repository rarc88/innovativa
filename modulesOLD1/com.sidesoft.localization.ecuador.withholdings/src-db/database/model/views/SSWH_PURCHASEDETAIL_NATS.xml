<?xml version="1.0"?>
  <database name="VIEW SSWH_PURCHASEDETAIL_NATS">
    <view name="SSWH_PURCHASEDETAIL_NATS"><![CDATA[SELECT x.posted, x.codigo_compra, x.cod_sustento, x.tipo_identificador, x.numero_ident, x.tipo_comprobante, x.tipo_proveedor, x.parte_relacionada, x.fecha_registro, x.establecimiento, x.punto_emision, x.secuencia, x.fecha_emision, x.autorizacion, abs(x.base_no_iva) AS base_no_iva, abs(x.base_iva_cero) AS base_iva_cero, abs(x.base_iva_doce) AS base_iva_doce, abs(x.monto_ice) AS monto_ice, abs(x.monto_iva) AS monto_iva, abs(x.ret_iva_10) AS ret_iva_10, abs(x.ret_iva_20) AS ret_iva_20, abs(x.ret_iva_30) AS ret_iva_30, abs(x.ret_iva_50) AS ret_iva_50, abs(x.ret_iva_70) AS ret_iva_70, abs(x.ret_iva_100) AS ret_iva_100, to_char(x.pago_local) AS pago_local, x.pais_pago, x.convenio_trib, x.norma_legal, x.establecimiento_ret, x.punto_emision_ret, x.secuencia_ret, x.autori_retencion, x.fecha_emision_ret, x.referencecreditnote, x.documento_creditnote, x.establecimiento_nc, x.punto_emision_nc, x.secuencia_nc, x.autorizacion_nc, x.ref_retencion, x.typedoc, x.poreference, x.fiscalregime, abs(x.base_excenta) AS base_excenta, x.ad_org_id, x.fiscalname, x.tipo_regimen, x.pais_pago_general, x.pais_pago_paraiso, x.deno_pago_regfis, x.c_invoice_id FROM (SELECT x_1.posted, x_1.documentno AS codigo_compra, x_1.cod_sustento, x_1.tipo_identificador, x_1.taxid AS numero_ident, x_1.tipo_comprobante, x_1.tipo_proveedor, x_1.parte_relacionada, x_1.fecha_registro, x_1.establecimiento, x_1.punto_emision, x_1.secuencia, x_1.fecha_emision, x_1.autorizacion, sum(x_1.base_no_iva) AS base_no_iva, sum(x_1.base_iva_cero) AS base_iva_cero, sum(x_1.base_iva_doce) AS base_iva_doce, sum(x_1.monto_ice) AS monto_ice, sum(x_1.monto_iva) AS monto_iva, sum(x_1.ret_iva_10) AS ret_iva_10, sum(x_1.ret_iva_20) AS ret_iva_20, sum(x_1.ret_iva_30) AS ret_iva_30, sum(x_1.ret_iva_50) AS ret_iva_50, sum(x_1.ret_iva_70) AS ret_iva_70, sum(x_1.ret_iva_100) AS ret_iva_100, to_char(x_1.pago_local) AS pago_local, to_char(COALESCE(x_1.pais_pago, 'NA')) AS pais_pago, to_char(x_1.convenio_trib) AS convenio_trib, to_char(x_1.norma_legal) AS norma_legal, x_1.establecimiento_retnew AS establecimiento_ret, x_1.punto_emision_retnew AS punto_emision_ret, x_1.secuencia_retnew AS secuencia_ret, x_1.autori_retencionnew AS autori_retencion, to_char(x_1.fecha_emision_retnew, 'DD/MM/YYYY') AS fecha_emision_ret, x_1.referencecreditnote, COALESCE(debit_credit.tipo_comprobante, x_1.documento_creditnote) AS documento_creditnote, COALESCE(debit_credit.establecimiento, x_1.establecimiento_nc) AS establecimiento_nc, COALESCE(debit_credit.caja, x_1.punto_emision_nc) AS punto_emision_nc, COALESCE(debit_credit.secuencia, x_1.secuencia_nc) AS secuencia_nc, COALESCE(debit_credit.autorizacion, x_1.autorizacion_nc) AS autorizacion_nc, COALESCE(to_char(x_1.em_sswh_withholdingref), to_char('')) AS ref_retencion, x_1.typedoc, x_1.poreference, to_char(x_1.fiscalregime) AS fiscalregime, sum(x_1.base_excenta) AS base_excenta, x_1.ad_org_id, x_1.fiscalname, x_1.tipo_regimen, x_1.pais_pago_general, x_1.pais_pago_paraiso, x_1.deno_pago_regfis, x_1.c_invoice_id FROM (SELECT a.posted, a.documentno, a.poreference, b.value AS cod_sustento, CASE c.em_sswh_taxidtype WHEN 'R' THEN to_char('01') WHEN 'P' THEN to_char('03') WHEN 'D' THEN to_char('02') WHEN 'C' THEN to_char('OTRO') ELSE NULL END AS tipo_identificador, c.taxid, d.value AS tipo_comprobante, tp.value AS tipo_proveedor, CASE tp.relatedpart WHEN 'Y' THEN to_char('SI') WHEN 'N' THEN to_char('NO') ELSE to_char('') END AS parte_relacionada, to_char(a.dateacct, 'DD/MM/YYYY') AS fecha_registro, substr(a.poreference, 1, 3) AS establecimiento, substr(a.poreference, 5, 3) AS punto_emision, substr(a.poreference, 9, 9) AS secuencia, to_char(a.dateinvoiced, 'DD/MM/YYYY') AS fecha_emision, a.em_sswh_nroauthorization AS autorizacion, COALESCE(sum(CASE f.em_sswh_isnoobjectvat WHEN 'Y' THEN e.taxbaseamt ELSE 0.00 END), 0) AS base_no_iva, sum(CASE WHEN f.em_sswh_isnoobjectvat = 'Y' OR f.em_sswh_isexempt = 'Y' THEN 0.00 ELSE CASE f.istaxdeductable WHEN 'Y' THEN CASE f.rate WHEN 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END END) AS base_iva_cero, sum(CASE f.istaxdeductable WHEN 'Y' THEN CASE WHEN f.rate <> 0 THEN e.taxbaseamt ELSE 0.00 END ELSE 0.00 END) AS base_iva_doce, 0.00 AS monto_ice, sum(CASE f.istaxdeductable WHEN 'Y' THEN CASE WHEN f.rate <> 0 THEN e.taxamt ELSE 0.00 END ELSE 0.00 END) AS monto_iva, sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-30) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) AS ret_iva_30, sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-50) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) AS ret_iva_50, sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-70) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) AS ret_iva_70, sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-100) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) AS ret_iva_100, sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-10) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) AS ret_iva_10, sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-20) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) AS ret_iva_20, CASE WHEN (sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-30) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-70) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-100) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END)) = 0 THEN NULL ELSE substr(a.em_sswh_withholdingref, 1, 3) END AS establecimiento_ret, CASE WHEN (sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-30) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-70) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-100) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END)) = 0 THEN NULL ELSE substr(a.em_sswh_withholdingref, 5, 3) END AS punto_emision_ret, CASE WHEN (sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-30) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-70) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-100) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END)) = 0 THEN NULL ELSE substr(a.em_sswh_withholdingref, 9, 9) END AS secuencia_ret, CASE WHEN (sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-30) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-70) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-100) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END)) = 0 THEN NULL ELSE a.em_sswh_authorization END AS autori_retencion, CASE WHEN (sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-30) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-70) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END) + sum(CASE f.em_sswh_ats_iva WHEN 'Y' THEN CASE f.rate WHEN (-100) THEN e.taxamt * (-1) ELSE 0.00 END ELSE 0.00 END)) = 0 THEN '' ELSE to_char(a.em_sswh_datewithhold, 'DD/MM/YYYY') END AS fecha_emision_ret, a.em_sswh_withholdingref, a.em_sswh_authorization, to_char(a.em_sswh_datewithhold, 'DD/MM/YYYY') AS em_sswh_datewithhold, CASE a.em_sswh_creditnote WHEN 'Y' THEN to_char(a.em_sswh_creditnotereference) ELSE to_char('') END AS referencecreditnote, to_char(an.documentno) AS documento_creditnote, to_char(substr(an.poreference, 1, 3)) AS establecimiento_nc, to_char(substr(an.poreference, 5, 3)) AS punto_emision_nc, to_char(substr(an.poreference, 9, 9)) AS secuencia_nc, dn.authorizationno AS autorizacion_nc, g.name AS typedoc, CASE WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) = 0 AND a.em_sswh_c_doctype_id IS NULL AND a.em_sswh_withholdingref IS NULL AND a.em_sswh_authorization IS NULL THEN NULL WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) <> 0 AND (a.em_sswh_c_doctype_id IS NULL OR a.em_sswh_withholdingref IS NULL OR a.em_sswh_authorization IS NULL) THEN NULL WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) <> 0 AND a.em_sswh_c_doctype_id IS NOT NULL AND a.em_sswh_withholdingref IS NOT NULL AND a.em_sswh_authorization IS NOT NULL THEN substr(a.em_sswh_withholdingref, 1, 3) ELSE NULL END AS establecimiento_retnew, CASE WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) = 0 AND a.em_sswh_c_doctype_id IS NULL AND a.em_sswh_withholdingref IS NULL AND a.em_sswh_authorization IS NULL THEN NULL WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) <> 0 AND (a.em_sswh_c_doctype_id IS NULL OR a.em_sswh_withholdingref IS NULL OR a.em_sswh_authorization IS NULL) THEN NULL WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) <> 0 AND a.em_sswh_c_doctype_id IS NOT NULL AND a.em_sswh_withholdingref IS NOT NULL AND a.em_sswh_authorization IS NOT NULL THEN substr(a.em_sswh_withholdingref, 5, 3) ELSE NULL END AS punto_emision_retnew, CASE WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) = 0 AND a.em_sswh_c_doctype_id IS NULL AND a.em_sswh_withholdingref IS NULL AND a.em_sswh_authorization IS NULL THEN NULL WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) <> 0 AND (a.em_sswh_c_doctype_id IS NULL OR a.em_sswh_withholdingref IS NULL OR a.em_sswh_authorization IS NULL) THEN NULL WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) <> 0 AND a.em_sswh_c_doctype_id IS NOT NULL AND a.em_sswh_withholdingref IS NOT NULL AND a.em_sswh_authorization IS NOT NULL THEN substr(a.em_sswh_withholdingref, 9, 9) ELSE NULL END AS secuencia_retnew, CASE WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) = 0 AND a.em_sswh_c_doctype_id IS NULL AND a.em_sswh_withholdingref IS NULL AND a.em_sswh_authorization IS NULL THEN NULL WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) <> 0 AND (a.em_sswh_c_doctype_id IS NULL OR a.em_sswh_withholdingref IS NULL OR a.em_sswh_authorization IS NULL) THEN NULL WHEN (a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat) <> 0 AND a.em_sswh_c_doctype_id IS NOT NULL AND a.em_sswh_withholdingref IS NOT NULL THEN CASE WHEN sswh_get_numatuh(a.c_invoice_id) <> 'ND' THEN sswh_get_numatuh(a.c_invoice_id) ELSE a.em_sswh_authorization END ELSE NULL END AS autori_retencionnew, a.em_sswh_datewithhold AS fecha_emision_retnew, l.em_sswh_typepayment AS pago_local, CASE WHEN l.em_sswh_typepayment = '02' THEN to_char(cc.em_sswh_regimecode) ELSE to_char('NA') END AS pais_pago, CASE WHEN l.em_sswh_typepayment = '02' THEN to_char(cc.description) ELSE to_char('NA') END AS convenio_trib, CASE WHEN cc.description = 'NO' AND l.em_sswh_typepayment = '02' THEN to_char(cc.em_sswh_designationtax) ELSE to_char('NA') END AS norma_legal, CASE WHEN l.em_sswh_typepayment = '02' THEN to_char(cc.ibancountry) WHEN l.em_sswh_typepayment = '01' THEN to_char('NA') ELSE NULL END AS fiscalregime, COALESCE(sum(CASE f.em_sswh_isexempt WHEN 'Y' THEN e.taxbaseamt ELSE 0.00 END), 0) AS base_excenta, a.ad_org_id, CASE c.em_sswh_taxidtype WHEN 'P' THEN to_char(c.name2) ELSE to_char(NULL) END AS fiscalname, tr.value AS tipo_regimen, CASE tr.value WHEN '01' THEN cc.em_sswh_regimecode ELSE 'NA' END AS pais_pago_general, CASE tr.value WHEN '02' THEN cc.em_sswh_regimecode ELSE 'NA' END AS pais_pago_paraiso, CASE tr.value WHEN '03' THEN cc.em_sswh_designationtax ELSE NULL END AS deno_pago_regfis, a.c_invoice_id FROM c_invoice a LEFT JOIN c_bpartner_location bpl ON a.c_bpartner_location_id = bpl.c_bpartner_location_id LEFT JOIN c_location cl ON bpl.c_location_id = cl.c_location_id LEFT JOIN c_country cc ON cc.c_country_id = cl.c_country_id LEFT JOIN sswh_taxregime tr ON cc.em_sswh_taxregime_id = tr.sswh_taxregime_id LEFT JOIN sswh_codelivelihoodt b ON a.em_sswh_codelivelihood = b.sswh_codelivelihoodt_id LEFT JOIN c_bpartner c ON a.c_bpartner_id = c.c_bpartner_id LEFT JOIN sswh_livelihoodt d ON a.em_sswh_livelihood = d.sswh_livelihoodt_id LEFT JOIN c_invoicetax e ON a.c_invoice_id = e.c_invoice_id LEFT JOIN c_tax f ON e.c_tax_id = f.c_tax_id LEFT JOIN c_doctype g ON a.c_doctype_id = g.c_doctype_id LEFT JOIN fin_paymentmethod l ON a.fin_paymentmethod_id = l.fin_paymentmethod_id LEFT JOIN sswh_countrypayment m ON l.em_sswh_countrypayment_id = m.sswh_countrypayment_id LEFT JOIN c_invoice an ON a.em_sswh_creditnotereference = an.c_invoice_id AND an.processed = 'Y' LEFT JOIN c_doctype bn ON an.c_doctype_id = bn.c_doctype_id AND bn.docbasetype = 'APC' LEFT JOIN c_bpartner cn ON an.c_bpartner_id = cn.c_bpartner_id LEFT JOIN sswh_authorization dn ON bn.c_doctype_id = dn.c_doctype_id AND to_char(an.documentno) >= to_char(dn.numberfrom) AND to_char(an.documentno) <= to_char(dn.numberto) LEFT JOIN sswh_taxpayer tp ON c.em_sswh_taxpayer_id = tp.sswh_taxpayer_id WHERE a.issotrx = 'N' AND a.processed = 'Y' AND a.posted <> 'VO' AND g.em_sswh_implementautoriza = 'Y' GROUP BY a.documentno, b.value, c.em_sswh_taxidtype, tp.relatedpart, c.taxid, tp.value, d.value, a.dateinvoiced, substr(a.poreference, 1, 3), substr(a.poreference, 5, 3), substr(a.poreference, 9, 9), a.em_sswh_authorization, f.em_sswh_ats_iva, f.istaxdeductable, f.rate, a.em_sswh_withholdingref, a.em_sswh_datewithhold, a.em_sswh_nroauthorization, a.em_sswh_creditnote, a.em_sswh_creditnotereference, an.documentno, a.poreference, substr(an.poreference, 1, 3), substr(an.poreference, 5, 3), substr(an.poreference, 9, 9), dn.authorizationno, g.name, a.posted, a.dateacct, a.em_sswh_totalwithholdingincome + a.em_sswh_totalwithholdingvat, a.em_sswh_c_doctype_id, l.em_sswh_typepayment, m.value, l.em_sswh_applydoubletax, l.em_sswh_subjecttowithholding, cc.ibancountry, a.ad_org_id, c.name2, tr.value, cc.em_sswh_regimecode, cc.em_sswh_designationtax, a.c_invoice_id, cc.description UNION ALL SELECT a.posted, e.documentno, e.poreference, g.value AS cod_sustento, CASE i.em_sswh_taxidtype WHEN 'R' THEN to_char('01') WHEN 'P' THEN to_char('03') WHEN 'D' THEN to_char('02') WHEN 'C' THEN to_char('OTRO') ELSE NULL END AS tipo_identificador, i.taxid, h.value AS tipo_comprobante, tp.value AS tipo_proveedor, CASE tp.relatedpart WHEN 'Y' THEN to_char('SI') WHEN 'N' THEN to_char('NO') ELSE to_char('') END AS parte_relacionada, to_char(CASE WHEN to_char(a.withholdingdate, to_char('MM')) = to_char((SELECT c_invoice.dateinvoiced FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id), to_char('MM')) THEN (SELECT c_invoice.dateinvoiced FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id) ELSE a.withholdingdate END, 'DD/MM/YYYY') AS fecha_registro, substr(e.poreference, 1, 3) AS establecimiento, substr(e.poreference, 5, 3) AS punto_emision, substr(e.poreference, 9, 9) AS secuencia, to_char(CASE WHEN to_char(a.withholdingdate, to_char('MM')) = to_char((SELECT c_invoice.dateinvoiced FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id), to_char('MM')) THEN (SELECT c_invoice.dateinvoiced FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id) ELSE a.withholdingdate END, 'DD/MM/YYYY') AS fecha_emision, e.em_sswh_nroauthorization AS autorizacion, COALESCE(sum(CASE WHEN k.em_sswh_isnoobjectvat = 'Y' THEN j.taxbaseamt ELSE 0.00 END), 0) AS base_no_iva, sum(CASE WHEN k.em_sswh_isnoobjectvat = 'Y' OR k.em_sswh_isexempt = 'Y' THEN 0.00 ELSE CASE WHEN to_char(a.withholdingdate, to_char('MM')) = to_char((SELECT c_invoice.dateinvoiced FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id), 'MM') THEN 0.00 ELSE CASE k.istaxdeductable WHEN 'Y' THEN CASE WHEN d.taxindicator = '0' THEN CASE k.rate WHEN 0 THEN COALESCE(j.taxbaseamt, CASE WHEN b.whivaamt = 0.00 THEN b.lineivaamt ELSE 0.00 END) ELSE 0.00 END ELSE 0.00 END ELSE 0.00 END END END) AS base_iva_cero, CASE WHEN to_char(a.withholdingdate, to_char('MM')) = to_char((SELECT c_invoice.dateinvoiced FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id), to_char('MM')) THEN 0.00 ELSE sum(CASE k.istaxdeductable WHEN 'Y' THEN CASE WHEN k.rate <> 0 THEN COALESCE(j.taxbaseamt, CASE WHEN b.whivaamt <> 0.00 THEN b.lineivaamt ELSE 0.00 END) ELSE 0.00 END ELSE 0.00 END) END AS base_iva_doce, 0.00 AS monto_ice, CASE WHEN to_char(a.withholdingdate, to_char('MM')) = to_char((SELECT c_invoice.dateinvoiced FROM c_invoice WHERE c_invoice.c_invoice_id = a.c_invoice_id), 'MM') THEN 0.00 ELSE sum(CASE k.istaxdeductable WHEN 'Y' THEN CASE WHEN k.rate <> 0 THEN j.taxamt ELSE 0.00 END ELSE 0.00 END) END AS monto_iva, sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-30) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) AS ret_iva_30, sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-50) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) AS ret_iva_50, sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-70) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) AS ret_iva_70, sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-100) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) AS ret_iva_100, sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-10) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) AS ret_iva_10, sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-20) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) AS ret_iva_20, CASE WHEN (sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-30) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-70) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-100) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END)) = 0 THEN NULL ELSE substr(e.em_sswh_withholdingref, 1, 3) END AS establecimiento_ret, CASE WHEN (sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-30) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-70) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-100) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END)) = 0 THEN NULL ELSE substr(e.em_sswh_withholdingref, 5, 3) END AS punto_emision_ret, CASE WHEN (sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-30) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-70) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-100) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END)) = 0 THEN NULL ELSE substr(e.em_sswh_withholdingref, 9, 9) END AS secuencia_ret, CASE WHEN (sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-30) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-70) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-100) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END)) = 0 THEN NULL ELSE e.em_sswh_authorization END AS autori_retencion, CASE WHEN (sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-30) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-70) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END) + sum(CASE d.em_sswh_ats_iva WHEN 'Y' THEN CASE d.rate WHEN (-100) THEN b.whivaamt ELSE 0.00 END ELSE 0.00 END)) = 0 THEN '' ELSE to_char(e.em_sswh_datewithhold, 'DD/MM/YYYY') END AS fecha_emision_ret, e.em_sswh_withholdingref, e.em_sswh_authorization, to_char(e.em_sswh_datewithhold, 'DD/MM/YYYY') AS em_sswh_datewithhold, CASE e.em_sswh_creditnote WHEN 'Y' THEN to_char(e.em_sswh_creditnotereference) ELSE to_char('') END AS referencecreditnote, to_char(an.documentno) AS documento_creditnote, to_char(substr(an.poreference, 1, 3)) AS establecimiento_nc, to_char(substr(an.poreference, 5, 3)) AS punto_emision_nc, to_char(substr(an.poreference, 9, 9)) AS secuencia_nc, dn.authorizationno AS autorizacion_nc, f.name AS typedoc, CASE WHEN sum(b.whivaamt) = 0 AND e.em_sswh_c_doctype_id IS NULL AND e.em_sswh_withholdingref IS NULL AND e.em_sswh_authorization IS NULL THEN NULL WHEN sum(b.whivaamt) <> 0 AND (e.em_sswh_c_doctype_id IS NULL OR e.em_sswh_withholdingref IS NULL OR e.em_sswh_authorization IS NULL) THEN NULL WHEN sum(b.whivaamt) <> 0 AND e.em_sswh_c_doctype_id IS NOT NULL AND e.em_sswh_withholdingref IS NOT NULL AND e.em_sswh_authorization IS NOT NULL THEN substr(e.em_sswh_withholdingref, 1, 3) ELSE NULL END AS establecimiento_retnew, CASE WHEN sum(b.whivaamt) = 0 AND e.em_sswh_c_doctype_id IS NULL AND e.em_sswh_withholdingref IS NULL AND e.em_sswh_authorization IS NULL THEN NULL WHEN sum(b.whivaamt) <> 0 AND (e.em_sswh_c_doctype_id IS NULL OR e.em_sswh_withholdingref IS NULL OR e.em_sswh_authorization IS NULL) THEN NULL WHEN sum(b.whivaamt) <> 0 AND e.em_sswh_c_doctype_id IS NOT NULL AND e.em_sswh_withholdingref IS NOT NULL AND e.em_sswh_authorization IS NOT NULL THEN substr(e.em_sswh_withholdingref, 5, 3) ELSE NULL END AS punto_emision_retnew, CASE WHEN sum(b.whivaamt) = 0 AND e.em_sswh_c_doctype_id IS NULL AND e.em_sswh_withholdingref IS NULL AND e.em_sswh_authorization IS NULL THEN NULL WHEN sum(b.whivaamt) <> 0 AND (e.em_sswh_c_doctype_id IS NULL OR e.em_sswh_withholdingref IS NULL OR e.em_sswh_authorization IS NULL) THEN NULL WHEN sum(b.whivaamt) <> 0 AND e.em_sswh_c_doctype_id IS NOT NULL AND e.em_sswh_withholdingref IS NOT NULL AND e.em_sswh_authorization IS NOT NULL THEN substr(e.em_sswh_withholdingref, 9, 9) ELSE NULL END AS secuencia_retnew, CASE WHEN sum(b.whivaamt) = 0 AND e.em_sswh_c_doctype_id IS NULL AND e.em_sswh_withholdingref IS NULL AND e.em_sswh_authorization IS NULL THEN NULL WHEN sum(b.whivaamt) <> 0 AND (e.em_sswh_c_doctype_id IS NULL OR e.em_sswh_withholdingref IS NULL OR e.em_sswh_authorization IS NULL) THEN NULL WHEN sum(b.whivaamt) <> 0 AND e.em_sswh_c_doctype_id IS NOT NULL AND e.em_sswh_withholdingref IS NOT NULL THEN CASE WHEN sswh_get_numatuh(e.c_invoice_id) = 'ND' THEN e.em_sswh_authorization ELSE sswh_get_numatuh(e.c_invoice_id) END ELSE NULL END AS autori_retencionnew, e.em_sswh_datewithhold AS fecha_emision_retnew, l.em_sswh_typepayment AS pago_local, CASE WHEN l.em_sswh_typepayment = '02' THEN to_char(cc.em_sswh_regimecode) ELSE to_char('NA') END AS pais_pago, CASE WHEN l.em_sswh_typepayment = '02' THEN to_char(cc.description) ELSE to_char('NA') END AS convenio_trib, CASE WHEN cc.description = 'NO' AND l.em_sswh_typepayment = '02' THEN to_char(cc.em_sswh_designationtax) ELSE to_char('NA') END AS norma_legal, CASE WHEN l.em_sswh_typepayment = '02' THEN to_char(cc.ibancountry) WHEN l.em_sswh_typepayment = '01' THEN to_char('NA') ELSE NULL END AS fiscalregime, COALESCE(sum(CASE k.em_sswh_isexempt WHEN 'Y' THEN j.taxbaseamt ELSE 0.00 END), 0) AS base_excenta, a.ad_org_id, CASE i.em_sswh_taxidtype WHEN 'P' THEN to_char(i.name2) ELSE to_char(NULL) END AS fiscalname, tr.value AS tipo_regimen, CASE tr.value WHEN '01' THEN cc.em_sswh_regimecode ELSE 'NA' END AS pais_pago_general, CASE tr.value WHEN '02' THEN cc.em_sswh_regimecode ELSE 'NA' END AS pais_pago_paraiso, CASE tr.value WHEN '03' THEN cc.em_sswh_designationtax ELSE NULL END AS deno_pago_regfis, a.c_invoice_id FROM ssws_withholdingsale a LEFT JOIN ssws_withholdingsaleline b ON a.ssws_withholdingsale_id = b.ssws_withholdingsale_id LEFT JOIN c_doctype c ON a.c_doctype_id = c.c_doctype_id LEFT JOIN c_tax d ON b.c_tax_id = d.c_tax_id LEFT JOIN c_invoice e ON a.c_invoice_id = e.c_invoice_id LEFT JOIN c_bpartner_location bpl ON e.c_bpartner_location_id = bpl.c_bpartner_location_id LEFT JOIN c_location cl ON bpl.c_location_id = cl.c_location_id LEFT JOIN c_country cc ON cc.c_country_id = cl.c_country_id LEFT JOIN sswh_taxregime tr ON cc.em_sswh_taxregime_id = tr.sswh_taxregime_id LEFT JOIN c_doctype f ON e.c_doctype_id = f.c_doctype_id LEFT JOIN sswh_codelivelihoodt g ON e.em_sswh_codelivelihood = g.sswh_codelivelihoodt_id LEFT JOIN sswh_livelihoodt h ON e.em_sswh_livelihood = h.sswh_livelihoodt_id LEFT JOIN c_bpartner i ON a.c_bpartner_id = i.c_bpartner_id LEFT JOIN fin_paymentmethod l ON e.fin_paymentmethod_id = l.fin_paymentmethod_id LEFT JOIN sswh_countrypayment m ON l.em_sswh_countrypayment_id = m.sswh_countrypayment_id LEFT JOIN sswh_taxpayer tp ON i.em_sswh_taxpayer_id = tp.sswh_taxpayer_id LEFT JOIN c_invoice an ON e.em_sswh_creditnotereference = an.c_invoice_id AND an.posted = 'CO' LEFT JOIN c_doctype bn ON an.c_doctype_id = bn.c_doctype_id AND bn.docbasetype = 'APC' LEFT JOIN c_bpartner cn ON an.c_bpartner_id = cn.c_bpartner_id LEFT JOIN sswh_authorization dn ON bn.c_doctype_id = dn.c_doctype_id AND to_char(an.documentno) >= to_char(dn.numberfrom) AND to_char(an.documentno) <= to_char(dn.numberto) LEFT JOIN c_invoicetax j ON e.c_invoice_id = j.c_invoice_id AND j.taxamt = b.lineivaamt LEFT JOIN c_tax k ON j.c_tax_id = k.c_tax_id WHERE a.withholdingtype = 'WP' AND a.processed = 'Y' AND a.docstatus <> 'VO' AND a.posted <> 'VO' AND c.em_sswh_implementautoriza = 'Y' AND d.em_sswh_ats_iva = 'Y' GROUP BY a.documentno, e.documentno, e.poreference, d.taxindicator, d.rate, f.name, d.name, a.c_bpartner_id, a.posted, a.withholdingdate, a.dateacct, e.em_sswh_withholdingref, a.c_invoice_id, g.value, i.em_sswh_taxidtype, i.taxid, h.value, tp.value, tp.relatedpart, e.em_sswh_nroauthorization, d.istaxundeductable, e.em_sswh_authorization, d.em_sswh_ats_iva, e.em_sswh_datewithhold, e.em_sswh_creditnote, e.em_sswh_creditnotereference, an.documentno, an.poreference, dn.authorizationno, e.em_sswh_c_doctype_id, l.em_sswh_typepayment, m.value, l.em_sswh_applydoubletax, l.em_sswh_subjecttowithholding, cc.ibancountry, a.ad_org_id, i.name2, tr.value, cc.em_sswh_regimecode, cc.em_sswh_designationtax, cc.description, e.c_invoice_id ORDER BY 2) x_1 LEFT JOIN (SELECT sswh_dc_note_v.tipo_comprobante, sswh_dc_note_v.establecimiento, sswh_dc_note_v.caja, sswh_dc_note_v.secuencia, sswh_dc_note_v.autorizacion, sswh_dc_note_v.c_invoice_id FROM sswh_dc_note_v) debit_credit ON debit_credit.c_invoice_id = x_1.c_invoice_id GROUP BY x_1.fecha_emision_retnew, x_1.autori_retencionnew, x_1.punto_emision_retnew, x_1.secuencia_retnew, x_1.establecimiento_retnew, x_1.documentno, x_1.poreference, x_1.cod_sustento, x_1.tipo_identificador, x_1.taxid, x_1.tipo_comprobante, x_1.tipo_proveedor, x_1.parte_relacionada, x_1.fecha_registro, x_1.establecimiento, x_1.punto_emision, x_1.secuencia, x_1.fecha_emision, x_1.autorizacion, x_1.em_sswh_withholdingref, x_1.em_sswh_authorization, x_1.em_sswh_datewithhold, x_1.referencecreditnote, x_1.documento_creditnote, x_1.establecimiento_nc, x_1.punto_emision_nc, x_1.secuencia_nc, x_1.autorizacion_nc, x_1.typedoc, x_1.posted, x_1.pago_local, x_1.pais_pago, x_1.convenio_trib, x_1.fiscalregime, x_1.ad_org_id, x_1.fiscalname, x_1.tipo_regimen, x_1.pais_pago_general, x_1.pais_pago_paraiso, x_1.deno_pago_regfis, x_1.c_invoice_id, debit_credit.tipo_comprobante, debit_credit.establecimiento, debit_credit.caja, debit_credit.secuencia, debit_credit.autorizacion, x_1.norma_legal ORDER BY x_1.documentno, x_1.ad_org_id) x]]></view>
  </database>
